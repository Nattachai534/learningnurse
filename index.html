<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบข้อมูลการศึกษาทางการพยาบาล</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #e91e63;
            --primary-light: #f8bbd9;
            --primary-dark: #ad1457;
            --secondary-color: #3f51b5;
            --accent-color: #ff4081;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --surface-color: rgba(255, 255, 255, 0.95);
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.2);
            --border-radius: 16px;
            --border-radius-small: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .main-container {
            min-height: 100vh;
            padding: 1rem;
            position: relative;
        }

        .background-decoration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
        }

        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
        }

        .bg-circle:nth-child(1) {
            width: 300px;
            height: 300px;
            top: 10%;
            right: 10%;
            animation: float 6s ease-in-out infinite;
        }

        .bg-circle:nth-child(2) {
            width: 200px;
            height: 200px;
            bottom: 15%;
            left: 5%;
            animation: float 8s ease-in-out infinite reverse;
        }

        .bg-circle:nth-child(3) {
            width: 150px;
            height: 150px;
            top: 50%;
            left: 15%;
            animation: float 10s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .logo {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-medium);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .logo:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-heavy);
        }

        .logo img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            position: relative;
            z-index: 1;
        }

        .header-content {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-family: 'Kanit', sans-serif;
            font-size: clamp(1.8rem, 5vw, 3rem);
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
            font-weight: 500;
        }

        .header .subtitle {
            font-size: clamp(1rem, 3vw, 1.2rem);
            color: var(--primary-color);
            font-weight: 600;
        }

        .nav-container {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-medium);
            backdrop-filter: blur(20px);
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .nav-tab {
            background: transparent;
            border: 2px solid transparent;
            padding: 1rem;
            color: var(--text-primary);
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--border-radius-small);
            transition: var(--transition);
            text-align: center;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
            border-color: var(--primary-light);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .nav-tab i {
            font-size: 1.5rem;
            opacity: 0.8;
        }

        .nav-tab.active i {
            opacity: 1;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-medium);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-heavy);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-light);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card-title {
            font-family: 'Kanit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--border-radius-small);
            border-left: 4px solid var(--primary-color);
        }

        .form-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius-small);
            background: white;
            font-family: 'Sarabun', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
            transform: translateY(-1px);
        }

        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: var(--transition);
        }

        .radio-item:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color);
        }

        .radio-item label {
            font-weight: 500;
            cursor: pointer;
            flex: 1;
        }

        .radio-item:has(input[type="radio"]:checked) {
            border-color: var(--primary-color);
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .course-section {
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius-small);
            padding: 1.5rem;
            margin-top: 1rem;
            border: 2px dashed var(--primary-light);
            transition: var(--transition);
        }

        .course-section.show {
            border-style: solid;
            background: white;
            box-shadow: var(--shadow-light);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .course-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-small);
            font-family: 'Sarabun', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #388e3c);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #f57c00);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color), #d32f2f);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .course-item {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius-small);
            border: 1px solid var(--primary-light);
            align-items: end;
            position: relative;
        }

        .course-item .delete-btn {
            grid-column: 1 / -1;
            justify-self: end;
            margin-top: 0.5rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--primary-color);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--primary-light);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .retirement-time-display {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 1px solid #2196f3;
            color: #1565c0;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            text-align: center;
            margin-top: 0.5rem;
        }

        .tooltip-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tooltip-info {
            position: relative;
        }

        .tooltip-info i {
            color: var(--primary-color);
            cursor: help;
            font-size: 1.1rem;
        }

        .tooltip-info:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: white;
            padding: 0.75rem;
            border-radius: var(--border-radius-small);
            font-size: 0.85rem;
            white-space: normal;
            max-width: 300px;
            width: max-content;
            z-index: 1000;
            box-shadow: var(--shadow-medium);
        }

        .tooltip-info:hover::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--text-primary);
            z-index: 1000;
        }

        .hidden {
            display: none !important;
        }

        .footer {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
            box-shadow: var(--shadow-medium);
            backdrop-filter: blur(20px);
        }

        .footer-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .footer h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-family: 'Kanit', sans-serif;
        }

        .footer p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container { padding: 0.5rem; }
            .header-content { padding: 1.5rem; }
            .nav-tabs { grid-template-columns: repeat(2, 1fr); }
            .card { padding: 1.5rem; }
            .form-grid { grid-template-columns: 1fr; gap: 1rem; }
            .radio-group { grid-template-columns: 1fr; }
            .course-item { grid-template-columns: 1fr; gap: 0.75rem; }
        }

        @media (max-width: 480px) {
            .logo-container { flex-direction: column; gap: 1rem; }
            .nav-tabs { grid-template-columns: 1fr; }
            .form-input, .form-select, .form-textarea { font-size: 16px; }
            .btn { padding: 0.875rem 1.25rem; font-size: 0.9rem; }
        }

        .input-container {
            position: relative;
        }

        .name-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius-small);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: var(--shadow-medium);
        }

        .name-suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid #f0f0f0;
        }

        .name-suggestion-item:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .name-suggestion-item:last-child {
            border-bottom: none;
        }

        .mt-1 {
            margin-top: 0.25rem;
        }

        .text-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="background-decoration">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>

    <div class="main-container">
        <div class="container">
            <header class="header">
                <div class="logo-container">
                    <div class="logo">
                        <img src="https://img5.pic.in.th/file/secure-sv1/logo-1-e1539059746524.png" alt="โลโก้โรงพยาบาลราชวิถี">
                    </div>
                </div>
                <div class="header-content">
                    <h1>ระบบข้อมูลการศึกษาทางการพยาบาล</h1>
                    <p class="subtitle">เฉพาะพยาบาลวิชาชีพ</p>
                    <p>งานถ่ายทอดการพยาบาล กลุ่มงานวิชาการพยาบาล</p>
                    <p>ภารกิจด้านการพยาบาล โรงพยาบาลราชวิถี</p>
                </div>
            </header>

            <nav class="nav-container">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('form')">
                        <i class="fas fa-user-graduate"></i>
                        <span>กรอกข้อมูลการศึกษา</span>
                    </button>
                    <button class="nav-tab" onclick="showTab('view')">
                        <i class="fas fa-eye"></i>
                        <span>ดูข้อมูลการศึกษา</span>
                    </button>
                    <button class="nav-tab" onclick="showTab('dashboard')">
                        <i class="fas fa-chart-pie"></i>
                        <span>Dashboard</span>
                    </button>
                    <button class="nav-tab" onclick="showTab('search')">
                        <i class="fas fa-search"></i>
                        <span>ค้นหาข้อมูล</span>
                    </button>
                </div>
            </nav>

            <div id="form" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-edit"></i>
                            แบบฟอร์มกรอกข้อมูลการศึกษา
                        </h2>
                    </div>

                    <form id="educationForm">
                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-user"></i>
                                ข้อมูลส่วนบุคคล
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="prefix">คำนำหน้า *</label>
                                    <div class="input-container">
                                        <select class="form-select" id="prefix" name="prefix" required>
                                            <option value="">เลือกคำนำหน้า</option>
                                            <option value="นาย">นาย</option>
                                            <option value="นาง">นาง</option>
                                            <option value="นางสาว">นางสาว</option>
                                            <option value="ดร.">ดร.</option>
                                            <option value="ผศ.ดร.">ผศ.ดร.</option>
                                            <option value="รศ.ดร.">รศ.ดร.</option>
                                            <option value="ศ.ดร.">ศ.ดร.</option>
                                            <option value="อื่นๆ">อื่นๆ (กรอกเพิ่มเติม)</option>
                                        </select>
                                        <input class="form-input mt-1 hidden" id="prefixOther" name="prefixOther" placeholder="กรอกคำนำหน้าอื่นๆ">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="firstName">ชื่อ *</label>
                                    <div class="input-container">
                                        <input class="form-input" type="text" id="firstName" name="firstName" placeholder="กรอกชื่อ" required>
                                        <div class="name-suggestions" id="firstNameSuggestions"></div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="lastName">นามสกุล *</label>
                                    <div class="input-container">
                                        <input class="form-input" type="text" id="lastName" name="lastName" placeholder="กรอกนามสกุล" required>
                                        <div class="name-suggestions" id="lastNameSuggestions"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="position">ตำแหน่ง *</label>
                                    <div class="input-container">
                                        <select class="form-select" id="position" name="position" required>
                                            <option value="">เลือกตำแหน่ง</option>
                                            <option value="พยาบาลวิชาชีพ">พยาบาลวิชาชีพ</option>
                                            <option value="พยาบาลเทคนิค">พยาบาลเทคนิค</option>
                                            <option value="นักวิชาการสาธารณสุข">นักวิชาการสาธารณสุข</option>
                                            <option value="อื่นๆ">อื่นๆ (กรอกเพิ่มเติม)</option>
                                        </select>
                                        <input class="form-input mt-1 hidden" id="positionOther" name="positionOther" placeholder="กรอกตำแหน่งอื่นๆ">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="level">ระดับ *</label>
                                    <div class="input-container">
                                        <select class="form-select" id="level" name="level" required>
                                            <option value="">เลือกระดับ</option>
                                            <option value="ไม่มี">ไม่มี</option>
                                            <option value="ปฏิบัติการ">ปฏิบัติการ</option>
                                            <option value="ชำนาญการ">ชำนาญการ</option>
                                            <option value="ชำนาญการพิเศษ">ชำนาญการพิเศษ</option>
                                            <option value="เชี่ยวชาญ">เชี่ยวชาญ</option>
                                            <option value="อื่นๆ">อื่นๆ (กรอกเพิ่มเติม)</option>
                                        </select>
                                        <input class="form-input mt-1 hidden" id="levelOther" name="levelOther" placeholder="กรอกระดับอื่นๆ">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="department">หน่วยงาน</label>
                                    <div class="input-container">
                                        <input class="form-input" type="text" id="department" name="department" placeholder="หน่วยงาน (จะถูกกรอกอัตโนมัติ)" readonly>
                                        <select class="form-select hidden" id="departmentSelect" name="departmentSelect">
                                            <option value="">เลือกหน่วยงาน</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="work">งาน</label>
                                    <div class="input-container">
                                        <input class="form-input" type="text" id="work" name="work" placeholder="งาน (จะถูกกรอกอัตโนมัติ)" readonly>
                                        <select class="form-select hidden" id="workSelect" name="workSelect">
                                            <option value="">เลือกงาน</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="workGroup">กลุ่มงาน</label>
                                    <div class="input-container">
                                        <input class="form-input" type="text" id="workGroup" name="workGroup" placeholder="กลุ่มงาน (จะถูกกรอกอัตโนมัติ)" readonly>
                                        <select class="form-select hidden" id="workGroupSelect" name="workGroupSelect">
                                            <option value="">เลือกกลุ่มงาน</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="licenseNumber">เลขที่ใบอนุญาตประกอบวิชาชีพ *</label>
                                    <input class="form-input" type="text" id="licenseNumber" name="licenseNumber" placeholder="กรอกเลขที่ใบอนุญาต" required>
                                </div>
                            </div>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="birthDate">วันเดือนปี เกิด *</label>
                                    <input class="form-input" type="date" id="birthDate" name="birthDate" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">วันเดือนปี เกษียณอายุ</label>
                                    <div class="retirement-time-display" id="retirementDisplay">
                                        จะคำนวณอัตโนมัติเมื่อกรอกวันเกิด
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">เวลาที่เหลือก่อนเกษียณ</label>
                                    <div class="retirement-time-display" id="remainingTimeDisplay">
                                        จะคำนวณอัตโนมัติเมื่อกรอกวันเกิด
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-graduation-cap"></i>
                                หลักสูตรการพยาบาลเฉพาะทาง *
                            </div>
                            <div class="radio-group">
                                <div class="radio-item" onclick="selectRadio('hasSpecializedYes')">
                                    <input type="radio" id="hasSpecializedYes" name="hasSpecializedCourse" value="เรียน" onchange="toggleSpecializedCourse()">
                                    <label for="hasSpecializedYes">เรียน</label>
                                </div>
                                <div class="radio-item" onclick="selectRadio('hasSpecializedNo')">
                                    <input type="radio" id="hasSpecializedNo" name="hasSpecializedCourse" value="ไม่ได้เรียน" onchange="toggleSpecializedCourse()">
                                    <label for="hasSpecializedNo">ไม่ได้เรียน</label>
                                </div>
                            </div>

                            <div id="specializedCourseSection" class="course-section hidden">
                                <div class="course-header">
                                    <h3 class="course-title">
                                        <i class="fas fa-list"></i>
                                        รายละเอียดหลักสูตรการพยาบาลเฉพาะทาง
                                    </h3>
                                    <button type="button" class="btn btn-primary btn-icon" onclick="addSpecializedCourse()" title="เพิ่มหลักสูตร">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="specializedCourseList">
                                    <div class="course-item">
                                        <div class="form-group">
                                            <label class="form-label">ชื่อหลักสูตร</label>
                                            <input class="form-input" type="text" name="specializedCourseName[]" placeholder="กรอกชื่อหลักสูตร">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">สถาบัน</label>
                                            <input class="form-input" type="text" name="specializedInstitution[]" placeholder="กรอกชื่อสถาบัน">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">ปีที่จบ</label>
                                            <input class="form-input" type="text" name="specializedGraduationYear[]" placeholder="กรอกปีที่จบ">
                                        </div>
                                        <button type="button" class="btn btn-danger btn-icon hidden delete-btn" onclick="removeSpecializedCourse(this)" title="ลบหลักสูตร">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-chalkboard-teacher"></i>
                                หลักสูตร Preceptor *
                            </div>
                            <div class="radio-group">
                                <div class="radio-item" onclick="selectRadio('hasPreceptorYes')">
                                    <input type="radio" id="hasPreceptorYes" name="hasPreceptorCourse" value="เรียน" onchange="togglePreceptorCourse()">
                                    <label for="hasPreceptorYes">เรียน</label>
                                </div>
                                <div class="radio-item" onclick="selectRadio('hasPreceptorNo')">
                                    <input type="radio" id="hasPreceptorNo" name="hasPreceptorCourse" value="ไม่ได้เรียน" onchange="togglePreceptorCourse()">
                                    <label for="hasPreceptorNo">ไม่ได้เรียน</label>
                                </div>
                            </div>

                            <div id="preceptorCourseSection" class="course-section hidden">
                                <div class="course-header">
                                    <h3 class="course-title">
                                        <i class="fas fa-list"></i>
                                        รายละเอียดหลักสูตร Preceptor
                                    </h3>
                                    <button type="button" class="btn btn-primary btn-icon" onclick="addPreceptorCourse()" title="เพิ่มหลักสูตร">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="preceptorCourseList">
                                    <div class="course-item">
                                        <div class="form-group">
                                            <label class="form-label">ระยะเวลาเรียน</label>
                                            <input class="form-input" type="text" name="preceptorDuration[]" placeholder="เช่น 40 ชั่วโมง">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">ปีที่จบ</label>
                                            <input class="form-input" type="text" name="preceptorGraduationYear[]" placeholder="กรอกปีที่จบ">
                                        </div>
                                        <button type="button" class="btn btn-danger btn-icon hidden delete-btn" onclick="removePreceptorCourse(this)" title="ลบหลักสูตร">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-user-graduate"></i>
                                หลักสูตรปริญญาโท *
                            </div>
                            <div class="radio-group">
                                <div class="radio-item" onclick="selectRadio('hasMastersYes')">
                                    <input type="radio" id="hasMastersYes" name="hasMastersDegree" value="เรียน" onchange="toggleMastersDegree()">
                                    <label for="hasMastersYes">เรียน</label>
                                </div>
                                <div class="radio-item" onclick="selectRadio('hasMastersNo')">
                                    <input type="radio" id="hasMastersNo" name="hasMastersDegree" value="ไม่ได้เรียน" onchange="toggleMastersDegree()">
                                    <label for="hasMastersNo">ไม่ได้เรียน</label>
                                </div>
                            </div>

                            <div id="mastersDegreeSection" class="course-section hidden">
                                <div class="course-header">
                                    <h3 class="course-title">
                                        <i class="fas fa-list"></i>
                                        รายละเอียดหลักสูตรปริญญาโท
                                    </h3>
                                    <button type="button" class="btn btn-primary btn-icon" onclick="addMastersDegree()" title="เพิ่มสาขา">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="mastersDegreeList">
                                    <div class="course-item">
                                        <div class="form-group">
                                            <label class="form-label">สาขา</label>
                                            <input class="form-input" type="text" name="mastersMajor[]" placeholder="กรอกสาขาวิชา">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">สถาบัน</label>
                                            <input class="form-input" type="text" name="mastersInstitution[]" placeholder="กรอกชื่อสถาบัน">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">ปีที่จบ</label>
                                            <input class="form-input" type="text" name="mastersGraduationYear[]" placeholder="กรอกปีที่จบ">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">ประเภทการศึกษา</label>
                                            <div class="tooltip-container">
                                                <select class="form-select" name="mastersEducationType[]">
                                                    <option value="">เลือกประเภทการศึกษา</option>
                                                    <option value="ภาคในเวลาราชการ">ภาคในเวลาราชการ</option>
                                                    <option value="ภาคนอกเวลาราชการ">ภาคนอกเวลาราชการ</option>
                                                </select>
                                                <div class="tooltip-info">
                                                    <i class="fas fa-info-circle" title="ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว หรือใช้ทุน กองทุนสนับสนุนด้านวิชาการ กรมการแพทย์ โดยผ่านระบบการทำสัญญาลาศึกษา | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัวโดยไม่ได้ทำสัญญาลาศึกษา"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">ทุนการศึกษา</label>
                                            <div class="input-container">
                                                <select class="form-select" name="mastersScholarship[]">
                                                    <option value="">เลือกทุนการศึกษา</option>
                                                    <option value="ทุนกรมการแพทย์">ทุนกรมการแพทย์</option>
                                                    <option value="ทุนรพ.ราชวิถี">ทุนรพ.ราชวิถี</option>
                                                    <option value="ทุนส่วนตัว">ทุนส่วนตัว</option>
                                                    <option value="อื่นๆ">อื่นๆ (กรอกเพิ่มเติม)</option>
                                                </select>
                                                <input class="form-input mt-1 hidden" name="mastersScholarshipOther[]" placeholder="ระบุทุนอื่นๆ">
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-danger btn-icon hidden delete-btn" onclick="removeMastersDegree(this)" title="ลบสาขา">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">
                                <i class="fas fa-award"></i>
                                หลักสูตรปริญญาเอก *
                            </div>
                            <div class="radio-group">
                                <div class="radio-item" onclick="selectRadio('hasDoctoralYes')">
                                    <input type="radio" id="hasDoctoralYes" name="hasDoctoralDegree" value="เรียน" onchange="toggleDoctoralDegree()">
                                    <label for="hasDoctoralYes">เรียน</label>
                                </div>
                                <div class="radio-item" onclick="selectRadio('hasDoctoralNo')">
                                    <input type="radio" id="hasDoctoralNo" name="hasDoctoralDegree" value="ไม่ได้เรียน" onchange="toggleDoctoralDegree()">
                                    <label for="hasDoctoralNo">ไม่ได้เรียน</label>
                                </div>
                            </div>

                            <div id="doctoralDegreeSection" class="course-section hidden">
                                <div class="course-header">
                                    <h3 class="course-title">
                                        <i class="fas fa-list"></i>
                                        รายละเอียดหลักสูตรปริญญาเอก
                                    </h3>
                                    <button type="button" class="btn btn-primary btn-icon" onclick="addDoctoralDegree()" title="เพิ่มสาขา">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="doctoralDegreeList">
                                    <div class="course-item">
                                        <div class="form-group">
                                            <label class="form-label">สาขา</label>
                                            <input class="form-input" type="text" name="doctoralMajor[]" placeholder="กรอกสาขาวิชา">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">สถาบัน</label>
                                            <input class="form-input" type="text" name="doctoralInstitution[]" placeholder="กรอกชื่อสถาบัน">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">ปีที่จบ</label>
                                            <input class="form-input" type="text" name="doctoralGraduationYear[]" placeholder="กรอกปีที่จบ">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">ประเภทการศึกษา</label>
                                            <div class="tooltip-container">
                                                <select class="form-select" name="doctoralEducationType[]">
                                                    <option value="">เลือกประเภทการศึกษา</option>
                                                    <option value="ภาคในเวลาราชการ">ภาคในเวลาราชการ</option>
                                                    <option value="ภาคนอกเวลาราชการ">ภาคนอกเวลาราชการ</option>
                                                </select>
                                                <div class="tooltip-info">
                                                    <i class="fas fa-info-circle" title="ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว หรือใช้ทุน กองทุนสนับสนุนด้านวิชาการ กรมการแพทย์ โดยผ่านระบบการทำสัญญาลาศึกษา | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัวโดยไม่ได้ทำสัญญาลาศึกษา"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">ทุนการศึกษา</label>
                                            <div class="input-container">
                                                <select class="form-select" name="doctoralScholarship[]">
                                                    <option value="">เลือกทุนการศึกษา</option>
                                                    <option value="ทุนกรมการแพทย์">ทุนกรมการแพทย์</option>
                                                    <option value="ทุนรพ.ราชวิถี">ทุนรพ.ราชวิถี</option>
                                                    <option value="ทุนส่วนตัว">ทุนส่วนตัว</option>
                                                    <option value="อื่นๆ">อื่นๆ (กรอกเพิ่มเติม)</option>
                                                </select>
                                                <input class="form-input mt-1 hidden" name="doctoralScholarshipOther[]" placeholder="ระบุทุนอื่นๆ">
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-danger btn-icon hidden delete-btn" onclick="removeDoctoralDegree(this)" title="ลบสาขา">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save"></i> บันทึกข้อมูลการศึกษา
                            </button>
                        </div>
                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem;">กำลังบันทึกข้อมูล...</p>
                        </div>
                    </form>
                </div>
            </div>

            <div id="view" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-eye"></i> ข้อมูลการศึกษา
                        </h2>
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="searchInput" class="form-input" placeholder="ค้นหาชื่อ-นามสกุล..." style="width: 300px; margin: 0;">
                            <button class="btn btn-success" onclick="exportData('csv')">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                            <button class="btn btn-warning" onclick="exportData('pdf')">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <div id="dataContainer">
                        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div> แสดง <span id="startEntry">1</span> ถึง <span id="endEntry">10</span> จากทั้งหมด <span id="totalEntries">0</span> รายการ </div>
                            <div>
                                <button class="btn btn-primary btn-icon" id="prevPage" disabled><i class="fas fa-chevron-left"></i></button>
                                <span id="currentPageDisplay">หน้า 1 / 1</span>
                                <button class="btn btn-primary btn-icon" id="nextPage" disabled><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ลำดับ</th>
                                    <th>คำนำหน้า</th>
                                    <th>ชื่อ-นามสกุล</th>
                                    <th>ตำแหน่ง</th>
                                    <th>ระดับ</th>
                                    <th>หน่วยงาน</th>
                                    <th>งาน</th>
                                    <th>กลุ่มงาน</th>
                                    <th>เลขที่ใบอนุญาต</th>
                                    <th>วันเกิด</th>
                                    <th>วันเกษียณ</th>
                                    <th>เหลือเวลา</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                </tbody>
                        </table>
                    </div>
                    <div class="loading" id="viewLoading">
                        <div class="spinner"></div>
                        <p style="margin-top: 1rem;">กำลังโหลดข้อมูล...</p>
                    </div>
                </div>
            </div>

            <div id="dashboard" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-pie"></i>
                            Dashboard ข้อมูลการศึกษา
                        </h2>
                        <div>
                            <label for="dashboardYear" class="form-label">ปีที่แสดง:</label>
                            <input type="number" id="dashboardYear" class="form-input" onchange="updateDashboard()">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        <div class="chart-container card">
                            <h3 class="card-title" style="margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; color: var(--secondary-color);">สถิติประเภทการศึกษา</h3>
                            <canvas id="educationTypeChart"></canvas>
                        </div>
                        <div class="chart-container card">
                            <h3 class="card-title" style="margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; color: var(--secondary-color);">สถิติหลักสูตรเฉพาะทางยอดนิยม 5 อันดับ</h3>
                            <canvas id="specializedCourseChart"></canvas>
                        </div>
                        <div class="chart-container card">
                            <h3 class="card-title" style="margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; color: var(--secondary-color);">สถิติหลักสูตรปริญญาโทสาขายอดนิยม 5 อันดับ</h3>
                            <canvas id="mastersDegreeChart"></canvas>
                        </div>
                        <div class="chart-container card">
                            <h3 class="card-title" style="margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; color: var(--secondary-color);">สถิติหลักสูตรปริญญาเอกสาขายอดนิยม 5 อันดับ</h3>
                            <canvas id="doctoralDegreeChart"></canvas>
                        </div>
                        <div class="chart-container card">
                            <h3 class="card-title" style="margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; color: var(--secondary-color);">สถิติจำนวนบุคลากรจำแนกตามตำแหน่ง</h3>
                            <canvas id="positionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="search" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-search"></i>
                            ค้นหาข้อมูลพยาบาล
                        </h2>
                        <input type="text" id="nurseSearchInput" class="form-input" placeholder="ค้นหาชื่อ-นามสกุล, ตำแหน่ง, หรือหน่วยงาน">
                    </div>
                    <div id="nurseSearchResults">
                        <p class="text-center" id="noSearchResults">ไม่มีข้อมูลที่ตรงกับการค้นหา</p>
                    </div>
                    <div class="loading" id="searchLoading">
                        <div class="spinner"></div>
                        <p style="margin-top: 1rem;">กำลังค้นหา...</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="footer-content">
                <h3>ระบบข้อมูลการศึกษาทางการพยาบาล</h3>
                <p>งานถ่ายทอดการพยาบาล กลุ่มงานวิชาการพยาบาล</p>
                <p>ภารกิจด้านการพยาบาล โรงพยาบาลราชวิถี</p>
                <p>&copy; 2024. All rights reserved.</p>
            </div>
        </footer>

    </div>

    <script>
        // REPLACE THIS WITH YOUR GOOGLE APPS SCRIPT WEB APP URL
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwgiUYsYKrjXgU8Vj3UjczIvLhq60NS5iL12GLX4u_609PL3mZSdHSBRO2rxjsabWdcTA/exec'; 

        // Global variables for data and pagination
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 10;
        let chartInstances = {}; // To store chart instances

        // --- Utility Functions for JSONP ---
        function jsonpRequest(url, callbackName, successCallback, errorCallback) {
            const script = document.createElement('script');
            script.src = `${url}&callback=${callbackName}`;
            script.onerror = function() {
                if (errorCallback) errorCallback(new Error('Network error or script loading failed.'));
            };
            document.body.appendChild(script);
            // Clean up the script tag after it loads or errors
            script.onload = () => {
                document.body.removeChild(script);
            };
            script.onerror = () => {
                document.body.removeChild(script);
            };
        }

        // --- Callbacks for JSONP requests ---
        function handleCheckConnectionResponse(data) {
            console.log('Connection Status:', data);
            const connectionStatusElement = document.getElementById('connectionStatus');
            if (connectionStatusElement) { // Check if the element exists on the page
                if (data.success) {
                    connectionStatusElement.textContent = 'เชื่อมต่อสำเร็จ';
                    connectionStatusElement.style.color = 'green';
                    Swal.fire('สำเร็จ', 'เชื่อมต่อกับระบบข้อมูลสำเร็จ', 'success');
                } else {
                    connectionStatusElement.textContent = 'เชื่อมต่อล้มเหลว';
                    connectionStatusElement.style.color = 'red';
                    Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับระบบข้อมูลได้: ' + (data.error || 'Unknown error'), 'error');
                }
            }
        }

        function handleGetAllDataResponse(data) {
            document.getElementById('viewLoading').classList.remove('show');
            if (data.success) {
                allData = data.data;
                filteredData = allData;
                displayData();
                updateDashboard();
                loadDepartmentAndWorkOptions();
            } else {
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้: ' + (data.error || 'Unknown error'), 'error');
            }
        }

        function handleGetDatabaseNamesResponse(data) {
            if (data.success) {
                const names = data.data;
                console.log('Database Names:', names); // Log the names for debugging
                // Store names for auto-suggestions
                window.allNames = names.map(n => ({
                    firstName: n.firstName,
                    lastName: n.lastName,
                    position: n.position,
                    department: n.department
                }));
            } else {
                console.error('Failed to load database names:', data.error);
            }
        }

        function handleGetStatsResponse(data) {
            if (data.success) {
                renderCharts(data.data);
            } else {
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลสถิติได้: ' + (data.error || 'Unknown error'), 'error');
            }
        }

        function handleSearchResponse(data) {
            document.getElementById('searchLoading').classList.remove('show');
            const searchResultsDiv = document.getElementById('nurseSearchResults');
            searchResultsDiv.innerHTML = ''; // Clear previous results
            const noResults = document.getElementById('noSearchResults');
            
            if (data.success && data.data && data.data.length > 0) {
                noResults.style.display = 'none';
                data.data.forEach(item => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'card';
                    resultItem.innerHTML = `
                        <p><strong>ชื่อ-นามสกุล:</strong> ${item.prefix} ${item.firstName} ${item.lastName}</p>
                        <p><strong>ตำแหน่ง:</strong> ${item.position}</p>
                        <p><strong>หน่วยงาน:</strong> ${item.department}</p>
                        <p><strong>เลขที่ใบอนุญาต:</strong> ${item.licenseNumber}</p>
                        `;
                    searchResultsDiv.appendChild(resultItem);
                });
            } else {
                noResults.style.display = 'block';
            }
        }
        
        // --- Core Functions ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.nav-tab[onclick="showTab('${tabId}')"]`).classList.add('active');

            if (tabId === 'view') {
                document.getElementById('viewLoading').classList.add('show');
                jsonpRequest(scriptURL + '?action=getAllData', 'handleGetAllDataResponse');
            } else if (tabId === 'dashboard') {
                updateDashboard();
            } else if (tabId === 'search') {
                // Clear search results and hide "no results" initially
                document.getElementById('nurseSearchResults').innerHTML = '';
                document.getElementById('noSearchResults').style.display = 'none';
                document.getElementById('nurseSearchInput').value = '';
            }
        }

        function selectRadio(id) {
            document.getElementById(id).checked = true;
            document.getElementById(id).dispatchEvent(new Event('change'));
        }

        function toggleSpecializedCourse() {
            const section = document.getElementById('specializedCourseSection');
            if (document.getElementById('hasSpecializedYes').checked) {
                section.classList.remove('hidden');
                section.classList.add('show');
            } else {
                section.classList.add('hidden');
                section.classList.remove('show');
            }
            updateDeleteButtons('specializedCourseList');
        }

        function addSpecializedCourse() {
            const list = document.getElementById('specializedCourseList');
            const newItem = document.createElement('div');
            newItem.className = 'course-item';
            newItem.innerHTML = `
                <div class="form-group">
                    <label class="form-label">ชื่อหลักสูตร</label>
                    <input class="form-input" type="text" name="specializedCourseName[]" placeholder="กรอกชื่อหลักสูตร">
                </div>
                <div class="form-group">
                    <label class="form-label">สถาบัน</label>
                    <input class="form-input" type="text" name="specializedInstitution[]" placeholder="กรอกชื่อสถาบัน">
                </div>
                <div class="form-group">
                    <label class="form-label">ปีที่จบ</label>
                    <input class="form-input" type="text" name="specializedGraduationYear[]" placeholder="กรอกปีที่จบ">
                </div>
                <button type="button" class="btn btn-danger btn-icon delete-btn" onclick="removeSpecializedCourse(this)" title="ลบหลักสูตร">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            list.appendChild(newItem);
            updateDeleteButtons('specializedCourseList');
        }

        function removeSpecializedCourse(button) {
            button.closest('.course-item').remove();
            updateDeleteButtons('specializedCourseList');
        }

        function togglePreceptorCourse() {
            const section = document.getElementById('preceptorCourseSection');
            if (document.getElementById('hasPreceptorYes').checked) {
                section.classList.remove('hidden');
                section.classList.add('show');
            } else {
                section.classList.add('hidden');
                section.classList.remove('show');
            }
            updateDeleteButtons('preceptorCourseList');
        }

        function addPreceptorCourse() {
            const list = document.getElementById('preceptorCourseList');
            const newItem = document.createElement('div');
            newItem.className = 'course-item';
            newItem.innerHTML = `
                <div class="form-group">
                    <label class="form-label">ระยะเวลาเรียน</label>
                    <input class="form-input" type="text" name="preceptorDuration[]" placeholder="เช่น 40 ชั่วโมง">
                </div>
                <div class="form-group">
                    <label class="form-label">ปีที่จบ</label>
                    <input class="form-input" type="text" name="preceptorGraduationYear[]" placeholder="กรอกปีที่จบ">
                </div>
                <button type="button" class="btn btn-danger btn-icon delete-btn" onclick="removePreceptorCourse(this)" title="ลบหลักสูตร">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            list.appendChild(newItem);
            updateDeleteButtons('preceptorCourseList');
        }

        function removePreceptorCourse(button) {
            button.closest('.course-item').remove();
            updateDeleteButtons('preceptorCourseList');
        }

        function toggleMastersDegree() {
            const section = document.getElementById('mastersDegreeSection');
            if (document.getElementById('hasMastersYes').checked) {
                section.classList.remove('hidden');
                section.classList.add('show');
            } else {
                section.classList.add('hidden');
                section.classList.remove('show');
            }
            updateDeleteButtons('mastersDegreeList');
        }

        function addMastersDegree() {
            const list = document.getElementById('mastersDegreeList');
            const newItem = document.createElement('div');
            newItem.className = 'course-item';
            newItem.innerHTML = `
                <div class="form-group">
                    <label class="form-label">สาขา</label>
                    <input class="form-input" type="text" name="mastersMajor[]" placeholder="กรอกสาขาวิชา">
                </div>
                <div class="form-group">
                    <label class="form-label">สถาบัน</label>
                    <input class="form-input" type="text" name="mastersInstitution[]" placeholder="กรอกชื่อสถาบัน">
                </div>
                <div class="form-group">
                    <label class="form-label">ปีที่จบ</label>
                    <input class="form-input" type="text" name="mastersGraduationYear[]" placeholder="กรอกปีที่จบ">
                </div>
                <div class="form-group">
                    <label class="form-label">ประเภทการศึกษา</label>
                    <div class="tooltip-container">
                        <select class="form-select" name="mastersEducationType[]">
                            <option value="">เลือกประเภทการศึกษา</option>
                            <option value="ภาคในเวลาราชการ">ภาคในเวลาราชการ</option>
                            <option value="ภาคนอกเวลาราชการ">ภาคนอกเวลาราชการ</option>
                        </select>
                        <div class="tooltip-info">
                            <i class="fas fa-info-circle" title="ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว หรือใช้ทุน กองทุนสนับสนุนด้านวิชาการ กรมการแพทย์ โดยผ่านระบบการทำสัญญาลาศึกษา | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัวโดยไม่ได้ทำสัญญาลาศึกษา"></i>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ทุนการศึกษา</label>
                    <div class="input-container">
                        <select class="form-select" name="mastersScholarship[]">
                            <option value="">เลือกทุนการศึกษา</option>
                            <option value="ทุนกรมการแพทย์">ทุนกรมการแพทย์</option>
                            <option value="ทุนรพ.ราชวิถี">ทุนรพ.ราชวิถี</option>
                            <option value="ทุนส่วนตัว">ทุนส่วนตัว</option>
                            <option value="อื่นๆ">อื่นๆ (กรอกเพิ่มเติม)</option>
                        </select>
                        <input class="form-input mt-1 hidden" name="mastersScholarshipOther[]" placeholder="ระบุทุนอื่นๆ">
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-icon delete-btn" onclick="removeMastersDegree(this)" title="ลบสาขา">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            list.appendChild(newItem);
            updateDeleteButtons('mastersDegreeList');
            attachScholarshipOtherListener(newItem);
        }

        function removeMastersDegree(button) {
            button.closest('.course-item').remove();
            updateDeleteButtons('mastersDegreeList');
        }

        function toggleDoctoralDegree() {
            const section = document.getElementById('doctoralDegreeSection');
            if (document.getElementById('hasDoctoralYes').checked) {
                section.classList.remove('hidden');
                section.classList.add('show');
            } else {
                section.classList.add('hidden');
                section.classList.remove('show');
            }
            updateDeleteButtons('doctoralDegreeList');
        }

        function addDoctoralDegree() {
            const list = document.getElementById('doctoralDegreeList');
            const newItem = document.createElement('div');
            newItem.className = 'course-item';
            newItem.innerHTML = `
                <div class="form-group">
                    <label class="form-label">สาขา</label>
                    <input class="form-input" type="text" name="doctoralMajor[]" placeholder="กรอกสาขาวิชา">
                </div>
                <div class="form-group">
                    <label class="form-label">สถาบัน</label>
                    <input class="form-input" type="text" name="doctoralInstitution[]" placeholder="กรอกชื่อสถาบัน">
                </div>
                <div class="form-group">
                    <label class="form-label">ปีที่จบ</label>
                    <input class="form-input" type="text" name="doctoralGraduationYear[]" placeholder="กรอกปีที่จบ">
                </div>
                <div class="form-group">
                    <label class="form-label">ประเภทการศึกษา</label>
                    <div class="tooltip-container">
                        <select class="form-select" name="doctoralEducationType[]">
                            <option value="">เลือกประเภทการศึกษา</option>
                            <option value="ภาคในเวลาราชการ">ภาคในเวลาราชการ</option>
                            <option value="ภาคนอกเวลาราชการ">ภาคนอกเวลาราชการ</option>
                        </select>
                        <div class="tooltip-info">
                            <i class="fas fa-info-circle" title="ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว หรือใช้ทุน กองทุนสนับสนุนด้านวิชาการ กรมการแพทย์ โดยผ่านระบบการทำสัญญาลาศึกษา | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัวโดยไม่ได้ทำสัญญาลาศึกษา"></i>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ทุนการศึกษา</label>
                    <div class="input-container">
                        <select class="form-select" name="doctoralScholarship[]">
                            <option value="">เลือกทุนการศึกษา</option>
                            <option value="ทุนกรมการแพทย์">ทุนกรมการแพทย์</option>
                            <option value="ทุนรพ.ราชวิถี">ทุนรพ.ราชวิถี</option>
                            <option value="ทุนส่วนตัว">ทุนส่วนตัว</option>
                            <option value="อื่นๆ">อื่นๆ (กรอกเพิ่มเติม)</option>
                        </select>
                        <input class="form-input mt-1 hidden" name="doctoralScholarshipOther[]" placeholder="ระบุทุนอื่นๆ">
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-icon delete-btn" onclick="removeDoctoralDegree(this)" title="ลบสาขา">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            list.appendChild(newItem);
            updateDeleteButtons('doctoralDegreeList');
            attachScholarshipOtherListener(newItem);
        }

        function removeDoctoralDegree(button) {
            button.closest('.course-item').remove();
            updateDeleteButtons('doctoralDegreeList');
        }

        function updateDeleteButtons(listId) {
            const list = document.getElementById(listId);
            const deleteButtons = list.querySelectorAll('.delete-btn');
            if (deleteButtons.length <= 1) {
                deleteButtons.forEach(btn => btn.classList.add('hidden'));
            } else {
                deleteButtons.forEach(btn => btn.classList.remove('hidden'));
            }
        }

        function calculateRetirementDate() {
            const birthDateInput = document.getElementById('birthDate');
            const retirementDisplay = document.getElementById('retirementDisplay');
            const remainingTimeDisplay = document.getElementById('remainingTimeDisplay');

            if (birthDateInput.value) {
                const birthDate = new Date(birthDateInput.value);
                const retirementDate = new Date(birthDate.getFullYear() + 60, birthDate.getMonth(), birthDate.getDate());
                
                // Adjust for Buddhist year (BE) if desired for display, assuming conversion is +543
                const retirementYearBE = retirementDate.getFullYear() + 543;
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                const formattedRetirementDate = retirementDate.toLocaleDateString('th-TH', options);

                retirementDisplay.textContent = formattedRetirementDate;

                const now = new Date();
                const diffTime = retirementDate.getTime() - now.getTime();
                if (diffTime > 0) {
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    const years = Math.floor(diffDays / 365);
                    const months = Math.floor((diffDays % 365) / 30);
                    const days = (diffDays % 365) % 30;
                    remainingTimeDisplay.textContent = `${years} ปี ${months} เดือน ${days} วัน`;
                } else {
                    remainingTimeDisplay.textContent = 'เกษียณอายุแล้ว';
                }

            } else {
                retirementDisplay.textContent = 'จะคำนวณอัตโนมัติเมื่อกรอกวันเกิด';
                remainingTimeDisplay.textContent = 'จะคำนวณอัตโนมัติเมื่อกรอกวันเกิด';
            }
        }

        function displayData() {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            paginatedData.forEach((item, index) => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = startIndex + index + 1;
                row.insertCell().textContent = item.prefix || '';
                row.insertCell().textContent = `${item.firstName || ''} ${item.lastName || ''}`;
                row.insertCell().textContent = item.position || '';
                row.insertCell().textContent = item.level || '';
                row.insertCell().textContent = item.department || '';
                row.insertCell().textContent = item.work || '';
                row.insertCell().textContent = item.workGroup || '';
                row.insertCell().textContent = item.licenseNumber || '';
                row.insertCell().textContent = item.birthDate ? new Date(item.birthDate).toLocaleDateString('th-TH') : '';
                row.insertCell().textContent = item.retirementDate ? new Date(item.retirementDate).toLocaleDateString('th-TH') : '';
                row.insertCell().textContent = item.remainingTime || '';

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn btn-warning btn-icon" onclick="editEntry('${item.id}')" title="แก้ไข">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-icon" onclick="deleteEntry('${item.id}')" title="ลบ">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            });

            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            document.getElementById('totalEntries').textContent = filteredData.length;
            document.getElementById('startEntry').textContent = Math.min(filteredData.length, (currentPage - 1) * rowsPerPage + 1);
            document.getElementById('endEntry').textContent = Math.min(filteredData.length, currentPage * rowsPerPage);
            document.getElementById('currentPageDisplay').textContent = `หน้า ${currentPage} / ${totalPages || 1}`;

            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            displayData();
        }

        async function exportData(type) {
            Swal.fire({
                title: `กำลังสร้างไฟล์ ${type.toUpperCase()}`,
                text: 'โปรดรอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: 'exportData', type: type }),
                });
                const result = await response.json();

                if (result.success) {
                    Swal.close();
                    if (result.url) {
                        window.open(result.url, '_blank');
                    } else {
                        Swal.fire('สำเร็จ', 'สร้างไฟล์สำเร็จ แต่ไม่มี URL ให้ดาวน์โหลด', 'success');
                    }
                } else {
                    Swal.fire('ข้อผิดพลาด', 'ไม่สามารถสร้างไฟล์ได้: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการส่งคำขอ: ' + error.message, 'error');
            }
        }

        function updateDashboard() {
            const year = document.getElementById('dashboardYear').value;
            document.getElementById('dashboardYear').value = year; // Ensure the input reflects the value

            // Request stats for the selected year using JSONP
            jsonpRequest(`${scriptURL}?action=getStats&year=${year}`, 'handleGetStatsResponse');
        }

        function renderCharts(stats) {
            const colors = {
                primary: 'var(--primary-color)',
                secondary: 'var(--secondary-color)',
                accent: 'var(--accent-color)',
                success: 'var(--success-color)',
                warning: 'var(--warning-color)',
                error: 'var(--error-color)',
                lightBlue: '#81d4fa',
                deepPurple: '#7c4dff',
                teal: '#009688',
                orange: '#ff9800',
                indigo: '#3f51b5'
            };

            const generateBackgroundColors = (count) => {
                const baseColors = [
                    colors.primary, colors.secondary, colors.success, colors.warning, colors.accent,
                    colors.lightBlue, colors.deepPurple, colors.teal, colors.orange, colors.indigo
                ];
                let bgColors = [];
                for (let i = 0; i < count; i++) {
                    bgColors.push(baseColors[i % baseColors.length]);
                }
                return bgColors;
            };

            // Destroy existing charts to prevent issues with updates
            for (const chartId in chartInstances) {
                if (chartInstances[chartId]) {
                    chartInstances[chartId].destroy();
                }
            }
            chartInstances = {};

            // Chart 1: Education Type Distribution
            const educationTypeCtx = document.getElementById('educationTypeChart').getContext('2d');
            chartInstances.educationTypeChart = new Chart(educationTypeCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(stats.educationType),
                    datasets: [{
                        data: Object.values(stats.educationType),
                        backgroundColor: generateBackgroundColors(Object.keys(stats.educationType).length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false,
                            text: 'สถิติประเภทการศึกษา'
                        }
                    }
                }
            });

            // Chart 2: Top 5 Specialized Courses
            const specializedCourseCtx = document.getElementById('specializedCourseChart').getContext('2d');
            const specializedLabels = stats.topSpecializedCourses.map(item => item.name);
            const specializedData = stats.topSpecializedCourses.map(item => item.count);
            chartInstances.specializedCourseChart = new Chart(specializedCourseCtx, {
                type: 'bar',
                data: {
                    labels: specializedLabels,
                    datasets: [{
                        label: 'จำนวนบุคลากร',
                        data: specializedData,
                        backgroundColor: generateBackgroundColors(specializedLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: 'สถิติหลักสูตรเฉพาะทางยอดนิยม 5 อันดับ'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });

            // Chart 3: Top 5 Masters Degrees
            const mastersDegreeCtx = document.getElementById('mastersDegreeChart').getContext('2d');
            const mastersLabels = stats.topMastersDegrees.map(item => item.name);
            const mastersData = stats.topMastersDegrees.map(item => item.count);
            chartInstances.mastersDegreeChart = new Chart(mastersDegreeCtx, {
                type: 'bar',
                data: {
                    labels: mastersLabels,
                    datasets: [{
                        label: 'จำนวนบุคลากร',
                        data: mastersData,
                        backgroundColor: generateBackgroundColors(mastersLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: 'สถิติหลักสูตรปริญญาโทสาขายอดนิยม 5 อันดับ'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });

            // Chart 4: Top 5 Doctoral Degrees
            const doctoralDegreeCtx = document.getElementById('doctoralDegreeChart').getContext('2d');
            const doctoralLabels = stats.topDoctoralDegrees.map(item => item.name);
            const doctoralData = stats.topDoctoralDegrees.map(item => item.count);
            chartInstances.doctoralDegreeChart = new Chart(doctoralDegreeCtx, {
                type: 'bar',
                data: {
                    labels: doctoralLabels,
                    datasets: [{
                        label: 'จำนวนบุคลากร',
                        data: doctoralData,
                        backgroundColor: generateBackgroundColors(doctoralLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: 'สถิติหลักสูตรปริญญาเอกสาขายอดนิยม 5 อันดับ'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });

            // Chart 5: Position Distribution
            const positionCtx = document.getElementById('positionChart').getContext('2d');
            const positionLabels = Object.keys(stats.positionDistribution);
            const positionData = Object.values(stats.positionDistribution);
            chartInstances.positionChart = new Chart(positionCtx, {
                type: 'doughnut',
                data: {
                    labels: positionLabels,
                    datasets: [{
                        data: positionData,
                        backgroundColor: generateBackgroundColors(positionLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false,
                            text: 'สถิติจำนวนบุคลากรจำแนกตามตำแหน่ง'
                        }
                    }
                }
            });
        }

        async function submitForm(event) {
            event.preventDefault();
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('loading').classList.add('show');

            const form = document.getElementById('educationForm');
            const formData = new FormData(form);
            const data = {};

            // Handle normal form fields
            for (let [key, value] of formData.entries()) {
                if (key.endsWith('[]')) {
                    const baseKey = key.slice(0, -2);
                    if (!data[baseKey]) {
                        data[baseKey] = [];
                    }
                    data[baseKey].push(value);
                } else if (key.endsWith('Other')) {
                    const baseKey = key.slice(0, -5);
                    if (formData.get(baseKey) === 'อื่นๆ') {
                        data[baseKey] = value;
                    }
                } else {
                    data[key] = value;
                }
            }

            // Manually handle radio button values
            data.hasSpecializedCourse = document.querySelector('input[name="hasSpecializedCourse"]:checked')?.value || 'ไม่ได้เรียน';
            data.hasPreceptorCourse = document.querySelector('input[name="hasPreceptorCourse"]:checked')?.value || 'ไม่ได้เรียน';
            data.hasMastersDegree = document.querySelector('input[name="hasMastersDegree"]:checked')?.value || 'ไม่ได้เรียน';
            data.hasDoctoralDegree = document.querySelector('input[name="hasDoctoralDegree"]:checked')?.value || 'ไม่ได้เรียน';

            // Special handling for dynamic lists
            ['specialized', 'preceptor', 'masters', 'doctoral'].forEach(type => {
                const items = document.querySelectorAll(`#${type}CourseList .course-item, #${type}DegreeList .course-item`);
                if (items.length > 0) {
                    data[`${type}Courses`] = Array.from(items).map(item => {
                        const courseData = {};
                        item.querySelectorAll('input, select').forEach(input => {
                            const name = input.name.replace(`${type}Name[]`, 'name')
                                                   .replace(`${type}Institution[]`, 'institution')
                                                   .replace(`${type}GraduationYear[]`, 'graduationYear')
                                                   .replace(`${type}Duration[]`, 'duration')
                                                   .replace(`${type}Major[]`, 'major')
                                                   .replace(`${type}EducationType[]`, 'educationType')
                                                   .replace(`${type}Scholarship[]`, 'scholarship')
                                                   .replace(`${type}ScholarshipOther[]`, 'scholarshipOther');
                            
                            // If it's an "Other" field for scholarship, only include if 'อื่นๆ' is selected
                            if (name === 'scholarshipOther') {
                                const scholarshipSelect = item.querySelector(`select[name="${type}Scholarship[]"]`);
                                if (scholarshipSelect && scholarshipSelect.value === 'อื่นๆ') {
                                    courseData[name] = input.value;
                                } else {
                                    courseData[name] = ''; // Ensure it's empty if 'อื่นๆ' not selected
                                }
                            } else {
                                courseData[name] = input.value;
                            }
                        });
                        return courseData;
                    });
                } else {
                    data[`${type}Courses`] = [];
                }
            });

            // Clean up empty scholarshipOther fields if "อื่นๆ" was not selected
            if (data.mastersCourses) {
                data.mastersCourses = data.mastersCourses.map(course => {
                    if (course.scholarship !== 'อื่นๆ') {
                        course.scholarshipOther = '';
                    }
                    return course;
                });
            }
            if (data.doctoralCourses) {
                data.doctoralCourses = data.doctoralCourses.map(course => {
                    if (course.scholarship !== 'อื่นๆ') {
                        course.scholarshipOther = '';
                    }
                    return course;
                });
            }

            // Add action
            data.action = 'addEntry';

            console.log('Sending Data:', data);

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Important for Google Apps Script doPost
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();
                console.log('Server Response:', result);

                document.getElementById('loading').classList.remove('show');
                document.getElementById('submitBtn').disabled = false;

                if (result.success) {
                    Swal.fire('สำเร็จ!', result.message, 'success');
                    form.reset();
                    // Reset dynamic sections
                    document.getElementById('specializedCourseList').innerHTML = getInitialCourseItemHtml('specialized');
                    document.getElementById('preceptorCourseList').innerHTML = getInitialCourseItemHtml('preceptor');
                    document.getElementById('mastersDegreeList').innerHTML = getInitialCourseItemHtml('masters');
                    document.getElementById('doctoralDegreeList').innerHTML = getInitialCourseItemHtml('doctoral');
                    toggleSpecializedCourse();
                    togglePreceptorCourse();
                    toggleMastersDegree();
                    toggleDoctoralDegree();
                    calculateRetirementDate(); // Reset retirement display
                    loadDatabaseNames(); // Reload names for suggestions
                    // Reattach listeners for dynamically added elements
                    attachDynamicListeners();

                    // Refresh view data if currently on view tab
                    if (document.getElementById('view').classList.contains('active')) {
                        document.getElementById('viewLoading').classList.add('show');
                        jsonpRequest(scriptURL + '?action=getAllData', 'handleGetAllDataResponse');
                    }
                } else {
                    Swal.fire('ข้อผิดพลาด!', result.error || 'เกิดข้อผิดพลาดไม่ทราบสาเหตุ', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').classList.remove('show');
                document.getElementById('submitBtn').disabled = false;
                Swal.fire('ข้อผิดพลาด!', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message, 'error');
            }
        }

        // Helper to get initial course item HTML
        function getInitialCourseItemHtml(type) {
            if (type === 'specialized') {
                return `
                    <div class="course-item">
                        <div class="form-group">
                            <label class="form-label">ชื่อหลักสูตร</label>
                            <input class="form-input" type="text" name="specializedCourseName[]" placeholder="กรอกชื่อหลักสูตร">
                        </div>
                        <div class="form-group">
                            <label class="form-label">สถาบัน</label>
                            <input class="form-input" type="text" name="specializedInstitution[]" placeholder="กรอกชื่อสถาบัน">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ปีที่จบ</label>
                            <input class="form-input" type="text" name="specializedGraduationYear[]" placeholder="กรอกปีที่จบ">
                        </div>
                        <button type="button" class="btn btn-danger btn-icon hidden delete-btn" onclick="removeSpecializedCourse(this)" title="ลบหลักสูตร">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else if (type === 'preceptor') {
                return `
                    <div class="course-item">
                        <div class="form-group">
                            <label class="form-label">ระยะเวลาเรียน</label>
                            <input class="form-input" type="text" name="preceptorDuration[]" placeholder="เช่น 40 ชั่วโมง">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ปีที่จบ</label>
                            <input class="form-input" type="text" name="preceptorGraduationYear[]" placeholder="กรอกปีที่จบ">
                        </div>
                        <button type="button" class="btn btn-danger btn-icon hidden delete-btn" onclick="removePreceptorCourse(this)" title="ลบหลักสูตร">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else if (type === 'masters') {
                return `
                    <div class="course-item">
                        <div class="form-group">
                            <label class="form-label">สาขา</label>
                            <input class="form-input" type="text" name="mastersMajor[]" placeholder="กรอกสาขาวิชา">
                        </div>
                        <div class="form-group">
                            <label class="form-label">สถาบัน</label>
                            <input class="form-input" type="text" name="mastersInstitution[]" placeholder="กรอกชื่อสถาบัน">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ปีที่จบ</label>
                            <input class="form-input" type="text" name="mastersGraduationYear[]" placeholder="กรอกปีที่จบ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ประเภทการศึกษา</label>
                            <div class="tooltip-container">
                                <select class="form-select" name="mastersEducationType[]">
                                    <option value="">เลือกประเภทการศึกษา</option>
                                    <option value="ภาคในเวลาราชการ">ภาคในเวลาราชการ</option>
                                    <option value="ภาคนอกเวลาราชการ">ภาคนอกเวลาราชการ</option>
                                </select>
                                <div class="tooltip-info">
                                    <i class="fas fa-info-circle" title="ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว หรือใช้ทุน กองทุนสนับสนุนด้านวิชาการ กรมการแพทย์ โดยผ่านระบบการทำสัญญาลาศึกษา | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัวโดยไม่ได้ทำสัญญาลาศึกษา"></i>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ทุนการศึกษา</label>
                            <div class="input-container">
                                <select class="form-select" name="mastersScholarship[]">
                                    <option value="">เลือกทุนการศึกษา</option>
                                    <option value="ทุนกรมการแพทย์">ทุนกรมการแพทย์</option>
                                    <option value="ทุนรพ.ราชวิถี">ทุนรพ.ราชวิถี</option>
                                    <option value="ทุนส่วนตัว">ทุนส่วนตัว</option>
                                    <option value="อื่นๆ">อื่นๆ (กรอกเพิ่มเติม)</option>
                                </select>
                                <input class="form-input mt-1 hidden" name="mastersScholarshipOther[]" placeholder="ระบุทุนอื่นๆ">
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger btn-icon hidden delete-btn" onclick="removeMastersDegree(this)" title="ลบสาขา">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            } else if (type === 'doctoral') {
                return `
                    <div class="course-item">
                        <div class="form-group">
                            <label class="form-label">สาขา</label>
                            <input class="form-input" type="text" name="doctoralMajor[]" placeholder="กรอกสาขาวิชา">
                        </div>
                        <div class="form-group">
                            <label class="form-label">สถาบัน</label>
                            <input class="form-input" type="text" name="doctoralInstitution[]" placeholder="กรอกชื่อสถาบัน">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ปีที่จบ</label>
                            <input class="form-input" type="text" name="doctoralGraduationYear[]" placeholder="กรอกปีที่จบ">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ประเภทการศึกษา</label>
                            <div class="tooltip-container">
                                <select class="form-select" name="doctoralEducationType[]">
                                    <option value="">เลือกประเภทการศึกษา</option>
                                    <option value="ภาคในเวลาราชการ">ภาคในเวลาราชการ</option>
                                    <option value="ภาคนอกเวลาราชการ">ภาคนอกเวลาราชการ</option>
                                </select>
                                <div class="tooltip-info">
                                    <i class="fas fa-info-circle" title="ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว หรือใช้ทุน กองทุนสนับสนุนด้านวิชาการ กรมการแพทย์ โดยผ่านระบบการทำสัญญาลาศึกษา | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัวโดยไม่ได้ทำสัญญาลาศึกษา"></i>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ทุนการศึกษา</label>
                            <div class="input-container">
                                <select class="form-select" name="doctoralScholarship[]">
                                    <option value="">เลือกทุนการศึกษา</option>
                                    <option value="ทุนกรมการแพทย์">ทุนกรมการแพทย์</option>
                                    <option value="ทุนรพ.ราชวิถี">ทุนรพ.ราชวิถี</option>
                                    <option value="ทุนส่วนตัว">ทุนส่วนตัว</option>
                                    <option value="อื่นๆ">อื่นๆ (กรอกเพิ่มเติม)</option>
                                </select>
                                <input class="form-input mt-1 hidden" name="doctoralScholarshipOther[]" placeholder="ระบุทุนอื่นๆ">
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger btn-icon hidden delete-btn" onclick="removeDoctoralDegree(this)" title="ลบสาขา">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }
            return '';
        }

        async function editEntry(id) {
            Swal.fire({
                title: 'กำลังโหลดข้อมูล...',
                text: 'โปรดรอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Using JSONP for GET request
                const callbackName = 'handleEditEntryResponse';
                window[callbackName] = function(data) {
                    Swal.close();
                    if (data.success) {
                        const entry = data.data;
                        if (entry) {
                            fillFormWithData(entry);
                            showTab('form'); // Switch to form tab for editing
                            window.scrollTo(0, 0); // Scroll to top
                        } else {
                            Swal.fire('ไม่พบข้อมูล', 'ไม่พบข้อมูลสำหรับ ID ที่ระบุ', 'error');
                        }
                    } else {
                        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลเพื่อแก้ไขได้: ' + (data.error || 'Unknown error'), 'error');
                    }
                    delete window[callbackName]; // Clean up global callback
                };
                jsonpRequest(`${scriptURL}?action=getEntryById&id=${id}`, callbackName);

            } catch (error) {
                console.error('Error fetching entry for edit:', error);
                Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการส่งคำขอ: ' + error.message, 'error');
            }
        }

        function fillFormWithData(data) {
            const form = document.getElementById('educationForm');
            form.reset(); // Clear current form

            // Fill basic fields
            for (const key in data) {
                const element = form.querySelector(`[name="${key}"]`);
                const selectElement = form.querySelector(`select[name="${key}"]`);
                const radioElements = form.querySelectorAll(`input[name="${key}"]`);

                if (element && element.type !== 'radio') {
                    element.value = data[key];
                    if (key === 'prefix' || key === 'position' || key === 'level') {
                        toggleOtherInput(element, data[key] + 'Other'); // Handle "อื่นๆ"
                    }
                } else if (selectElement) {
                    selectElement.value = data[key];
                    if (key === 'department' || key === 'work' || key === 'workGroup') {
                        // For auto-filled selects, ensure the readonly input is also updated
                        document.getElementById(key).value = data[key];
                    }
                } else if (radioElements.length > 0) {
                    radioElements.forEach(radio => {
                        if (radio.value === data[key]) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change')); // Trigger toggle functions
                        }
                    });
                }
            }

            // Fill dynamic course/degree sections
            ['specialized', 'preceptor', 'masters', 'doctoral'].forEach(type => {
                const listId = `${type}CourseList` || `${type}DegreeList`;
                const list = document.getElementById(listId);
                list.innerHTML = ''; // Clear existing items

                const items = data[`${type}Courses`];
                if (items && items.length > 0) {
                    items.forEach(itemData => {
                        const newItem = document.createElement('div');
                        newItem.className = 'course-item';
                        let itemHtml = '';
                        if (type === 'specialized') {
                            itemHtml = `
                                <div class="form-group">
                                    <label class="form-label">ชื่อหลักสูตร</label>
                                    <input class="form-input" type="text" name="specializedCourseName[]" placeholder="กรอกชื่อหลักสูตร" value="${itemData.name || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">สถาบัน</label>
                                    <input class="form-input" type="text" name="specializedInstitution[]" placeholder="กรอกชื่อสถาบัน" value="${itemData.institution || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ปีที่จบ</label>
                                    <input class="form-input" type="text" name="specializedGraduationYear[]" placeholder="กรอกปีที่จบ" value="${itemData.graduationYear || ''}">
                                </div>
                                <button type="button" class="btn btn-danger btn-icon delete-btn" onclick="removeSpecializedCourse(this)" title="ลบหลักสูตร">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        } else if (type === 'preceptor') {
                            itemHtml = `
                                <div class="form-group">
                                    <label class="form-label">ระยะเวลาเรียน</label>
                                    <input class="form-input" type="text" name="preceptorDuration[]" placeholder="เช่น 40 ชั่วโมง" value="${itemData.duration || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ปีที่จบ</label>
                                    <input class="form-input" type="text" name="preceptorGraduationYear[]" placeholder="กรอกปีที่จบ" value="${itemData.graduationYear || ''}">
                                </div>
                                <button type="button" class="btn btn-danger btn-icon delete-btn" onclick="removePreceptorCourse(this)" title="ลบหลักสูตร">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        } else if (type === 'masters') {
                             itemHtml = `
                                <div class="form-group">
                                    <label class="form-label">สาขา</label>
                                    <input class="form-input" type="text" name="mastersMajor[]" placeholder="กรอกสาขาวิชา" value="${itemData.major || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">สถาบัน</label>
                                    <input class="form-input" type="text" name="mastersInstitution[]" placeholder="กรอกชื่อสถาบัน" value="${itemData.institution || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ปีที่จบ</label>
                                    <input class="form-input" type="text" name="mastersGraduationYear[]" placeholder="กรอกปีที่จบ" value="${itemData.graduationYear || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ประเภทการศึกษา</label>
                                    <div class="tooltip-container">
                                        <select class="form-select" name="mastersEducationType[]">
                                            <option value="">เลือกประเภทการศึกษา</option>
                                            <option value="ภาคในเวลาราชการ" ${itemData.educationType === 'ภาคในเวลาราชการ' ? 'selected' : ''}>ภาคในเวลาราชการ</option>
                                            <option value="ภาคนอกเวลาราชการ" ${itemData.educationType === 'ภาคนอกเวลาราชการ' ? 'selected' : ''}>ภาคนอกเวลาราชการ</option>
                                        </select>
                                        <div class="tooltip-info">
                                            <i class="fas fa-info-circle" title="ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว หรือใช้ทุน กองทุนสนับสนุนด้านวิชาการ กรมการแพทย์ โดยผ่านระบบการทำสัญญาลาศึกษา | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัวโดยไม่ได้ทำสัญญาลาศึกษา"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ทุนการศึกษา</label>
                                    <div class="input-container">
                                        <select class="form-select" name="mastersScholarship[]" onchange="toggleOtherInput(this, 'mastersScholarshipOther[]')">
                                            <option value="">เลือกทุนการศึกษา</option>
                                            <option value="ทุนกรมการแพทย์" ${itemData.scholarship === 'ทุนกรมการแพทย์' ? 'selected' : ''}>ทุนกรมการแพทย์</option>
                                            <option value="ทุนรพ.ราชวิถี" ${itemData.scholarship === 'ทุนรพ.ราชวิถี' ? 'selected' : ''}>ทุนรพ.ราชวิถี</option>
                                            <option value="ทุนส่วนตัว" ${itemData.scholarship === 'ทุนส่วนตัว' ? 'selected' : ''}>ทุนส่วนตัว</option>
                                            <option value="อื่นๆ" ${itemData.scholarship === 'อื่นๆ' ? 'selected' : ''}>อื่นๆ (กรอกเพิ่มเติม)</option>
                                        </select>
                                        <input class="form-input mt-1 ${itemData.scholarship === 'อื่นๆ' ? '' : 'hidden'}" name="mastersScholarshipOther[]" placeholder="ระบุทุนอื่นๆ" value="${itemData.scholarshipOther || ''}">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-danger btn-icon delete-btn" onclick="removeMastersDegree(this)" title="ลบสาขา">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        } else if (type === 'doctoral') {
                            itemHtml = `
                                <div class="form-group">
                                    <label class="form-label">สาขา</label>
                                    <input class="form-input" type="text" name="doctoralMajor[]" placeholder="กรอกสาขาวิชา" value="${itemData.major || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">สถาบัน</label>
                                    <input class="form-input" type="text" name="doctoralInstitution[]" placeholder="กรอกชื่อสถาบัน" value="${itemData.institution || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ปีที่จบ</label>
                                    <input class="form-input" type="text" name="doctoralGraduationYear[]" placeholder="กรอกปีที่จบ" value="${itemData.graduationYear || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ประเภทการศึกษา</label>
                                    <div class="tooltip-container">
                                        <select class="form-select" name="doctoralEducationType[]">
                                            <option value="">เลือกประเภทการศึกษา</option>
                                            <option value="ภาคในเวลาราชการ" ${itemData.educationType === 'ภาคในเวลาราชการ' ? 'selected' : ''}>ภาคในเวลาราชการ</option>
                                            <option value="ภาคนอกเวลาราชการ" ${itemData.educationType === 'ภาคนอกเวลาราชการ' ? 'selected' : ''}>ภาคนอกเวลาราชการ</option>
                                        </select>
                                        <div class="tooltip-info">
                                            <i class="fas fa-info-circle" title="ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว หรือใช้ทุน กองทุนสนับสนุนด้านวิชาการ กรมการแพทย์ โดยผ่านระบบการทำสัญญาลาศึกษา | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัวโดยไม่ได้ทำสัญญาลาศึกษา"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ทุนการศึกษา</label>
                                    <div class="input-container">
                                        <select class="form-select" name="doctoralScholarship[]" onchange="toggleOtherInput(this, 'doctoralScholarshipOther[]')">
                                            <option value="">เลือกทุนการศึกษา</option>
                                            <option value="ทุนกรมการแพทย์" ${itemData.scholarship === 'ทุนกรมการแพทย์' ? 'selected' : ''}>ทุนกรมการแพทย์</option>
                                            <option value="ทุนรพ.ราชวิถี" ${itemData.scholarship === 'ทุนรพ.ราชวิถี' ? 'selected' : ''}>ทุนรพ.ราชวิถี</option>
                                            <option value="ทุนส่วนตัว" ${itemData.scholarship === 'ทุนส่วนตัว' ? 'selected' : ''}>ทุนส่วนตัว</option>
                                            <option value="อื่นๆ" ${itemData.scholarship === 'อื่นๆ' ? 'selected' : ''}>อื่นๆ (กรอกเพิ่มเติม)</option>
                                        </select>
                                        <input class="form-input mt-1 ${itemData.scholarship === 'อื่นๆ' ? '' : 'hidden'}" name="doctoralScholarshipOther[]" placeholder="ระบุทุนอื่นๆ" value="${itemData.scholarshipOther || ''}">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-danger btn-icon delete-btn" onclick="removeDoctoralDegree(this)" title="ลบสาขา">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        }
                        newItem.innerHTML = itemHtml;
                        list.appendChild(newItem);
                        attachScholarshipOtherListener(newItem); // Reattach listener for newly added items
                    });
                    // Ensure radio button for 'เรียน' is checked if there are items
                    const yesRadio = document.getElementById(`has${capitalizeFirstLetter(type)}Yes`);
                    if (yesRadio) {
                        yesRadio.checked = true;
                        yesRadio.dispatchEvent(new Event('change'));
                    }
                } else {
                    // If no items, ensure 'ไม่ได้เรียน' is checked and section is hidden
                    const noRadio = document.getElementById(`has${capitalizeFirstLetter(type)}No`);
                    if (noRadio) {
                        noRadio.checked = true;
                        noRadio.dispatchEvent(new Event('change'));
                    }
                }
            });

            calculateRetirementDate(); // Recalculate based on loaded birth date
            form.querySelector('button[type="submit"]').textContent = 'อัปเดตข้อมูลการศึกษา';
            form.setAttribute('data-edit-id', data.id); // Store ID for update
        }

        async function deleteEntry(id) {
            Swal.fire({
                title: 'คุณแน่ใจหรือไม่?',
                text: "คุณต้องการลบข้อมูลนี้ใช่หรือไม่?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ใช่, ลบเลย!',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'กำลังลบข้อมูล...',
                        text: 'โปรดรอสักครู่',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    try {
                        const response = await fetch(scriptURL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain;charset=utf-8',
                            },
                            body: JSON.stringify({ action: 'deleteEntry', id: id }),
                        });
                        const result = await response.json();

                        if (result.success) {
                            Swal.fire('ลบสำเร็จ!', result.message, 'success');
                            document.getElementById('viewLoading').classList.add('show');
                            jsonpRequest(scriptURL + '?action=getAllData', 'handleGetAllDataResponse'); // Reload data
                        } else {
                            Swal.fire('ข้อผิดพลาด!', result.error || 'ไม่สามารถลบข้อมูลได้', 'error');
                        }
                    } catch (error) {
                        console.error('Error deleting entry:', error);
                        Swal.fire('ข้อผิดพลาด!', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message, 'error');
                    }
                }
            });
        }

        function toggleOtherInput(selectElement, otherInputName) {
            const parentContainer = selectElement.closest('.input-container') || selectElement.closest('.form-group');
            const otherInput = parentContainer.querySelector(`[name="${otherInputName}"]`);

            if (otherInput) {
                if (selectElement.value === 'อื่นๆ') {
                    otherInput.classList.remove('hidden');
                    otherInput.setAttribute('required', 'true');
                } else {
                    otherInput.classList.add('hidden');
                    otherInput.removeAttribute('required');
                    otherInput.value = ''; // Clear value when hidden
                }
            }
        }

        function loadDepartmentAndWorkOptions() {
            const departments = [...new Set(allData.map(item => item.department).filter(Boolean))].sort();
            const works = [...new Set(allData.map(item => item.work).filter(Boolean))].sort();
            const workGroups = [...new Set(allData.map(item => item.workGroup).filter(Boolean))].sort();

            populateSelect('departmentSelect', departments);
            populateSelect('workSelect', works);
            populateSelect('workGroupSelect', workGroups);
        }

        function populateSelect(selectId, optionsArray) {
            const selectElement = document.getElementById(selectId);
            const currentInput = document.getElementById(selectId.replace('Select', ''));

            if (optionsArray.length > 0) {
                selectElement.innerHTML = '<option value="">เลือก...</option>';
                optionsArray.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    selectElement.appendChild(opt);
                });
                selectElement.classList.remove('hidden');
                currentInput.classList.add('hidden');
            } else {
                selectElement.classList.add('hidden');
                currentInput.classList.remove('hidden');
            }
        }

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial checks for dynamically shown/hidden sections
            toggleSpecializedCourse();
            togglePreceptorCourse();
            toggleMastersDegree();
            toggleDoctoralDegree();

            // Attach event listeners
            document.getElementById('educationForm').addEventListener('submit', submitForm);
            document.getElementById('birthDate').addEventListener('change', calculateRetirementDate);
            document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(1));

            document.getElementById('searchInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filteredData = allData.filter(item => {
                    const fullName = `${item.firstName} ${item.lastName}`.toLowerCase();
                    return fullName.includes(searchTerm) ||
                           item.position.toLowerCase().includes(searchTerm) ||
                           item.department.toLowerCase().includes(searchTerm);
                });
                currentPage = 1;
                displayData();
            });

            document.getElementById('nurseSearchInput').addEventListener('input', function() {
                const searchTerm = this.value.trim();
                document.getElementById('searchLoading').classList.add('show');
                if (searchTerm.length > 2) { // Only search if at least 3 characters
                     // Using JSONP for GET request
                    const callbackName = 'handleSearchResponse';
                    jsonpRequest(`${scriptURL}?action=searchData&query=${encodeURIComponent(searchTerm)}`, callbackName);
                } else {
                    document.getElementById('searchLoading').classList.remove('show');
                    document.getElementById('nurseSearchResults').innerHTML = '';
                    document.getElementById('noSearchResults').style.display = 'none';
                }
            });

            // Handle "อื่นๆ" select fields
            document.getElementById('prefix').addEventListener('change', (e) => toggleOtherInput(e.target, 'prefixOther'));
            document.getElementById('position').addEventListener('change', (e) => toggleOtherInput(e.target, 'positionOther'));
            document.getElementById('level').addEventListener('change', (e) => toggleOtherInput(e.target, 'levelOther'));

            function attachScholarshipOtherListener(container) {
                const scholarshipSelects = container.querySelectorAll('select[name$="Scholarship[]"]');
                scholarshipSelects.forEach(select => {
                    select.addEventListener('change', (e) => {
                        const otherInputName = e.target.name.replace('Scholarship[]', 'ScholarshipOther[]');
                        toggleOtherInput(e.target, otherInputName);
                    });
                    // Trigger on load for existing values
                    const otherInput = select.closest('.input-container').querySelector(`input[name="${select.name.replace('Scholarship[]', 'ScholarshipOther[]')}"]`);
                    if (otherInput) {
                        if (select.value === 'อื่นๆ') {
                            otherInput.classList.remove('hidden');
                        } else {
                            otherInput.classList.add('hidden');
                            otherInput.value = '';
                        }
                    }
                });
            }

            function attachDynamicListeners() {
                document.querySelectorAll('.course-item').forEach(item => {
                    attachScholarshipOtherListener(item);
                });
            }

            // Click outside to hide suggestions
            document.addEventListener('click', function(event) {
                const suggestions = document.querySelectorAll('.name-suggestions');
                suggestions.forEach(suggestion => {
                    if (!suggestion.contains(event.target) && !suggestion.previousElementSibling.contains(event.target)) {
                        suggestion.style.display = 'none';
                    }
                });
            });

            // Initialize delete button visibility
            updateDeleteButtons('specializedCourseList');
            updateDeleteButtons('preceptorCourseList');
            updateDeleteButtons('mastersDegreeList');
            updateDeleteButtons('doctoralDegreeList');

            // Set current year for dashboard
            const currentYear = new Date().getFullYear() + 543; // Assuming BE year
            document.getElementById('dashboardYear').value = currentYear.toString();

            // Load initial data for auto-suggestions and connection status
            jsonpRequest(scriptURL + '?action=getDatabaseNames', 'handleGetDatabaseNamesResponse');
            // The connection status will be checked by JSONP callback `handleCheckConnectionResponse`
            jsonpRequest(scriptURL + '?action=checkConnection', 'handleCheckConnectionResponse');
        });

        // Autocomplete/Suggestions (Remains the same as it doesn't involve direct Apps Script calls)
        let nameSuggestionsTimeout;
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const firstNameSuggestionsDiv = document.getElementById('firstNameSuggestions');
        const lastNameSuggestionsDiv = document.getElementById('lastNameSuggestions');

        firstNameInput.addEventListener('input', () => debounceSuggestNames(firstNameInput, firstNameSuggestionsDiv, 'firstName'));
        lastNameInput.addEventListener('input', () => debounceSuggestNames(lastNameInput, lastNameSuggestionsDiv, 'lastName'));

        function debounceSuggestNames(inputElement, suggestionsDiv, type) {
            clearTimeout(nameSuggestionsTimeout);
            nameSuggestionsTimeout = setTimeout(() => {
                const searchTerm = inputElement.value.toLowerCase();
                if (searchTerm.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                displaySuggestions(searchTerm, suggestionsDiv, type);
            }, 300);
        }

        function displaySuggestions(searchTerm, suggestionsDiv, type) {
            if (!window.allNames) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const uniqueSuggestions = new Set();
            window.allNames.forEach(item => {
                if (type === 'firstName' && item.firstName && item.firstName.toLowerCase().includes(searchTerm)) {
                    uniqueSuggestions.add(item.firstName);
                } else if (type === 'lastName' && item.lastName && item.lastName.toLowerCase().includes(searchTerm)) {
                    uniqueSuggestions.add(item.lastName);
                }
            });

            suggestionsDiv.innerHTML = '';
            if (uniqueSuggestions.size > 0) {
                Array.from(uniqueSuggestions).slice(0, 10).forEach(suggestion => { // Limit to 10 suggestions
                    const item = document.createElement('div');
                    item.className = 'name-suggestion-item';
                    item.textContent = suggestion;
                    item.onclick = () => {
                        if (type === 'firstName') {
                            firstNameInput.value = suggestion;
                            // Attempt to fill other fields if a match is found
                            const matchedUser = window.allNames.find(u => u.firstName === suggestion);
                            if (matchedUser) {
                                lastNameInput.value = matchedUser.lastName || '';
                                document.getElementById('department').value = matchedUser.department || '';
                                document.getElementById('position').value = matchedUser.position || '';
                                // Trigger change for auto-filled selects if they become active
                                const deptSelect = document.getElementById('departmentSelect');
                                if (matchedUser.department && Array.from(deptSelect.options).some(opt => opt.value === matchedUser.department)) {
                                    document.getElementById('department').classList.add('hidden');
                                    deptSelect.classList.remove('hidden');
                                    deptSelect.value = matchedUser.department;
                                } else {
                                    document.getElementById('department').classList.remove('hidden');
                                    deptSelect.classList.add('hidden');
                                }
                            }
                        } else if (type === 'lastName') {
                            lastNameInput.value = suggestion;
                             const matchedUser = window.allNames.find(u => u.lastName === suggestion);
                            if (matchedUser) {
                                firstNameInput.value = matchedUser.firstName || '';
                                document.getElementById('department').value = matchedUser.department || '';
                                document.getElementById('position').value = matchedUser.position || '';
                                // Trigger change for auto-filled selects if they become active
                                const deptSelect = document.getElementById('departmentSelect');
                                if (matchedUser.department && Array.from(deptSelect.options).some(opt => opt.value === matchedUser.department)) {
                                    document.getElementById('department').classList.add('hidden');
                                    deptSelect.classList.remove('hidden');
                                    deptSelect.value = matchedUser.department;
                                } else {
                                    document.getElementById('department').classList.remove('hidden');
                                    deptSelect.classList.add('hidden');
                                }
                            }
                        }
                        suggestionsDiv.style.display = 'none';
                    };
                    suggestionsDiv.appendChild(item);
                });
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>
</body>
</html>

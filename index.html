<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบข้อมูลการศึกษาทางการพยาบาล</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #e91e63; --primary-light: #f8bbd0; --primary-dark: #c2185b;
            --secondary-color: #3f51b5; --accent-color: #ff4081; --success-color: #4caf50;
            --warning-color: #ff9800; --error-color: #f44336; --info-color: #2196f3;
            --background-gradient: linear-gradient(135deg, #fce4ec 0%, #e1bee7 100%);
            --surface-color: rgba(255, 255, 255, 0.9); --text-primary: #333; --text-secondary: #555;
            --shadow-light: 0 2px 8px rgba(0,0,0,0.07); --shadow-medium: 0 4px 15px rgba(0,0,0,0.1);
            --border-radius: 12px; --border-radius-small: 8px;
            --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Sarabun', sans-serif; background: var(--background-gradient);
            min-height: 100vh; color: var(--text-primary); line-height: 1.7;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        .header { text-align: center; margin-bottom: 2rem; }
        .logo-container {
            margin-bottom: 1.5rem; display: flex; justify-content: center;
        }
        .logo {
            width: 100px; height: 100px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-medium);
        }
        .logo img { width: 80px; height: 80px; }
        .header-content {
            background: var(--surface-color); padding: 2rem; border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .header h1 {
            font-family: 'Kanit', sans-serif; font-size: 2.5rem; font-weight: 700;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text; color: transparent; background-clip: text;
            margin-bottom: 0.5rem;
        }
        .header p { font-size: 1.1rem; color: var(--text-secondary); }
        .nav-container {
            background: var(--surface-color); border-radius: 50px; padding: 0.5rem;
            margin-bottom: 2rem; box-shadow: var(--shadow-medium);
            display: flex; justify-content: center;
        }
        .nav-tabs { display: flex; gap: 0.5rem; }
        .nav-tab {
            background: transparent; border: none; padding: 0.75rem 1.5rem;
            color: var(--text-secondary); font-family: 'Sarabun', sans-serif;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            border-radius: 50px; transition: var(--transition);
            display: flex; align-items: center; gap: 0.5rem;
        }
        .nav-tab:hover { background: var(--primary-light); color: var(--primary-dark); }
        .nav-tab.active {
            background: var(--primary-color); color: white;
            box-shadow: var(--shadow-light);
        }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card {
            background: var(--surface-color); border-radius: var(--border-radius);
            padding: 2.5rem; box-shadow: var(--shadow-medium);
            backdrop-filter: blur(10px); margin-bottom: 2rem;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;
            border-bottom: 1px solid #eee;
        }
        .card-title {
            font-family: 'Kanit', sans-serif; font-size: 1.8rem;
            font-weight: 600; color: var(--primary-dark);
            display: flex; align-items: center; gap: 1rem;
        }
        .form-section {
            margin-bottom: 2.5rem; padding: 2rem; background: rgba(255,255,255,0.5);
            border-radius: var(--border-radius); border-left: 5px solid var(--primary-color);
        }
        .form-section-title {
            font-size: 1.4rem; font-weight: 600; color: var(--primary-dark);
            margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;
        }
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.75rem;
        }
        .form-group { position: relative; }
        .form-label {
            display: block; font-weight: 600; color: var(--text-primary);
            margin-bottom: 0.5rem; font-size: 0.95rem;
        }
        .form-input, .form-select {
            width: 100%; padding: 0.8rem 1rem; border: 1px solid #ddd;
            border-radius: var(--border-radius-small); background: white;
            font-family: 'Sarabun', sans-serif; font-size: 1rem;
            transition: var(--transition);
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        .form-input[readonly] { background-color: #f5f5f5; cursor: not-allowed; }
        .radio-group { display: flex; gap: 1rem; margin-top: 0.5rem; }
        .radio-item {
            display: flex; align-items: center; flex: 1;
            padding: 0.8rem 1.2rem; background: white; border: 1px solid #ddd;
            border-radius: var(--border-radius-small); cursor: pointer; transition: var(--transition);
        }
        .radio-item:hover { border-color: var(--primary-light); }
        .radio-item input[type="radio"] { width: 18px; height: 18px; accent-color: var(--primary-color); margin-right: 0.75rem;}
        .radio-item.checked { border-color: var(--primary-color); background: var(--primary-light); }
        .course-section { display: none; margin-top: 1.5rem; }
        .course-section.show { display: block; }
        .course-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem;
        }
        .course-title { font-size: 1.1rem; font-weight: 600; color: var(--primary-dark); }
        .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 50px;
            font-family: 'Sarabun', sans-serif; font-weight: 600; cursor: pointer;
            transition: var(--transition); display: inline-flex; align-items: center;
            gap: 0.5rem; text-decoration: none;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background: #f1f1f1; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-danger { background: var(--error-color); color: white; }
        .btn-warning { background: var(--warning-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-icon { padding: 0.75rem; width: 44px; height: 44px; border-radius: 50%; justify-content: center; }
        .course-item {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem;
            background: rgba(255,255,255,0.8); border-radius: var(--border-radius);
            border: 1px solid #eee; align-items: end;
        }
        .delete-btn-container { grid-column: 1 / -1; text-align: right; }
        .retirement-time-display {
            background: var(--primary-light); color: var(--primary-dark);
            padding: 0.8rem 1rem; border-radius: var(--border-radius-small);
            font-weight: 600; text-align: center; margin-top: 0.5rem; min-height: 47px;
            display: flex; align-items: center; justify-content: center;
        }
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-icon { color: var(--primary-color); cursor: help; margin-left: 8px; }
        .tooltip-text {
            visibility: hidden; width: 250px; background-color: #555; color: #fff;
            text-align: center; border-radius: 6px; padding: 8px; position: absolute;
            z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0;
            transition: opacity 0.3s; font-size: 0.85rem; font-weight: 400;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .hidden { display: none !important; }
        .footer {
            text-align: center; margin-top: 3rem; padding: 2rem; color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.7); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--primary-light);
            border-top-color: var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .name-suggestions {
            position: absolute; top: 100%; left: 0; right: 0; background: white;
            border: 1px solid #ddd; border-radius: var(--border-radius-small);
            max-height: 200px; overflow-y: auto; z-index: 1000;
            box-shadow: var(--shadow-medium);
        }
        .name-suggestion-item { padding: 0.75rem 1rem; cursor: pointer; transition: background 0.2s; }
        .name-suggestion-item:hover { background: var(--primary-light); }
        .data-table { width: 100%; border-collapse: collapse; background: white; overflow: hidden; border-radius: var(--border-radius); box-shadow: var(--shadow-medium); }
        .data-table th, .data-table td { padding: 1rem 1.5rem; text-align: left; }
        .data-table thead { background: var(--primary-dark); color: white; }
        .data-table tbody tr { border-bottom: 1px solid #eee; }
        .data-table tbody tr:last-child { border-bottom: none; }
        .data-table tbody tr:hover { background-color: #fcf4f7; }
        .table-actions button { margin: 0 4px; padding: 0.5rem 1rem; font-size: 0.9rem; }
        .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 3rem;
            border: 1px solid #888; width: 90%; max-width: 800px;
            border-radius: var(--border-radius); position: relative;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-close {
            position: absolute; top: 1rem; right: 1.5rem; color: #aaa;
            font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .detail-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        .detail-section h4 { color: var(--primary-dark); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-light); }
        .detail-section p { margin-bottom: 0.5rem; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;}
        .stat-card {
            color: white; padding: 1.5rem; border-radius: var(--border-radius);
            text-align: center; transition: var(--transition);
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-medium); }
        .stat-card i { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.8; }
        .stat-card h3 { font-size: 2.5rem; }
        .chart-container { background: white; padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-medium); }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-size: 1.2rem; color: var(--primary-dark); font-weight: 600;">กำลังประมวลผล...</p>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo-container">
                <div class="logo">
                    <img src="https://img5.pic.in.th/file/secure-sv1/logo-1-e1539059746524.png" alt="Logo">
                </div>
            </div>
            <div class="header-content">
                <h1>ระบบข้อมูลการศึกษาทางการพยาบาล</h1>
                <p>งานถ่ายทอดการพยาบาล กลุ่มงานวิชาการพยาบาล, ภารกิจด้านการพยาบาล โรงพยาบาลราชวิถี</p>
            </div>
        </header>

        <nav class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="form" onclick="showTab('form')"><i class="fas fa-edit"></i><span>กรอก/แก้ไขข้อมูล</span></button>
                <button class="nav-tab" data-tab="view" onclick="showTab('view')"><i class="fas fa-list-alt"></i><span>ดูข้อมูลทั้งหมด</span></button>
                <button class="nav-tab" data-tab="dashboard" onclick="showTab('dashboard')"><i class="fas fa-chart-pie"></i><span>Dashboard</span></button>
                <button class="nav-tab" data-tab="search" onclick="showTab('search')"><i class="fas fa-search"></i><span>ค้นหา</span></button>
            </div>
        </nav>

        <div id="form" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" id="formTitle"><i class="fas fa-user-plus"></i>แบบฟอร์มกรอกข้อมูล</h2>
                </div>
                <form id="educationForm">
                    <input type="hidden" id="recordId" name="id">
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-user"></i>ข้อมูลส่วนบุคคล</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="prefix">คำนำหน้า *</label>
                                <select class="form-select" id="prefix" name="prefix" required></select>
                                <input class="form-input hidden mt-2" id="prefixOther" name="prefixOther" placeholder="กรอกคำนำหน้าอื่นๆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="firstName">ชื่อ *</label>
                                <div style="position:relative;">
                                    <input class="form-input" type="text" id="firstName" name="firstName" placeholder="พิมพ์เพื่อค้นหา..." required>
                                    <div class="name-suggestions hidden" id="firstNameSuggestions"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="lastName">นามสกุล *</label>
                                 <div style="position:relative;">
                                    <input class="form-input" type="text" id="lastName" name="lastName" placeholder="พิมพ์เพื่อค้นหา..." required>
                                    <div class="name-suggestions hidden" id="lastNameSuggestions"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="position">ตำแหน่ง *</label>
                                <select class="form-select" id="position" name="position" required></select>
                                <input class="form-input hidden mt-2" id="positionOther" name="positionOther" placeholder="กรอกตำแหน่งอื่นๆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="level">ระดับ *</label>
                                <select class="form-select" id="level" name="level" required></select>
                                <input class="form-input hidden mt-2" id="levelOther" name="levelOther" placeholder="กรอกระดับอื่นๆ">
                            </div>
                             <div class="form-group">
                                <label class="form-label" for="licenseNumber">เลขที่ใบอนุญาตประกอบวิชาชีพ *</label>
                                <input class="form-input" type="text" id="licenseNumber" name="licenseNumber" placeholder="กรอกเลขที่ใบอนุญาต" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="department">หน่วยงาน</label>
                                <input class="form-input" type="text" id="department" name="department" placeholder="เลือกชื่อ/นามสกุล เพื่อกรอกอัตโนมัติ" readonly>
                                <select class="form-select hidden" id="departmentSelect" name="departmentSelect"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="work">งาน</label>
                                <input class="form-input" type="text" id="work" name="work" placeholder="เลือกชื่อ/นามสกุล เพื่อกรอกอัตโนมัติ" readonly>
                                <select class="form-select hidden" id="workSelect" name="workSelect"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="workGroup">กลุ่มงาน</label>
                                <input class="form-input" type="text" id="workGroup" name="workGroup" placeholder="เลือกชื่อ/นามสกุล เพื่อกรอกอัตโนมัติ" readonly>
                                 <select class="form-select hidden" id="workGroupSelect" name="workGroupSelect"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="birthDate">วันเดือนปี เกิด *</label>
                                <input class="form-input" type="date" id="birthDate" name="birthDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">วันเดือนปี เกษียณอายุ</label>
                                <div class="retirement-time-display" id="retirementDisplay">กรอกวันเกิดเพื่อคำนวณ</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">เวลาที่เหลือก่อนเกษียณ</label>
                                <div class="retirement-time-display" id="remainingTimeDisplay">กรอกวันเกิดเพื่อคำนวณ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="education-sections-container"></div>

                    <div class="text-center mt-5">
                        <button type="submit" class="btn btn-primary" id="submitBtn"><i class="fas fa-save"></i> บันทึกข้อมูล</button>
                        <button type="button" class="btn btn-secondary" id="resetBtn" onclick="resetForm()"><i class="fas fa-undo"></i>ล้างฟอร์ม</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="view" class="tab-content">
            <div class="card">
                 <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-list-alt"></i>ข้อมูลทั้งหมด</h2>
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                         <input type="text" id="viewSearchInput" class="form-input" placeholder="ค้นหา..." style="width: 250px;">
                         <select id="sortSelect" class="form-select" style="width: 200px;">
                            <option value="newest">เรียงลำดับ: ใหม่สุด</option>
                            <option value="oldest">เก่าสุด</option>
                            <option value="name_asc">ชื่อ (ก-ฮ)</option>
                            <option value="name_desc">ชื่อ (ฮ-ก)</option>
                         </select>
                         <button class="btn btn-success" onclick="exportData('csv')"><i class="fas fa-file-csv"></i> CSV</button>
                         <button class="btn btn-primary" onclick="exportData('pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ลำดับ</th><th>ชื่อ-นามสกุล</th><th>ตำแหน่ง</th><th>หน่วยงาน</th><th style="text-align: center;">การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
                <div class="pagination-controls">
                    <div id="dataCount" style="color: var(--text-secondary);"></div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="changePage(-1)" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
                        <span id="pageInfo" style="padding: 0.5rem 1rem;"></span>
                        <button class="btn btn-secondary" onclick="changePage(1)" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
             <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-pie"></i>Dashboard สรุปข้อมูล</h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <label>ข้อมูลสำหรับปีเกษียณ พ.ศ.:</label>
                        <select id="dashboardYearSelect" class="form-select" style="width: 150px;"></select>
                    </div>
                </div>
                <div id="dashboardContent">
                    <div class="dashboard-grid" id="statCardsContainer"></div>
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); margin-top: 2rem;">
                        <div class="chart-container">
                            <h4 class="course-title">สัดส่วนการศึกษาต่อ</h4>
                            <canvas id="educationPieChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4 class="course-title">ประเภทการศึกษา (ป.โท และ ป.เอก)</h4>
                            <canvas id="educationTypeBarChart"></canvas>
                        </div>
                         <div class="chart-container">
                            <h4 class="course-title">จำนวนผู้เกษียณอายุในแต่ละปี</h4>
                            <canvas id="retirementBarChart"></canvas>
                        </div>
                        <div class="chart-container">
                             <h4 class="course-title" id="retirementListTitle">รายชื่อผู้เกษียณอายุปี พ.ศ. 2568</h4>
                             <div id="retirementList" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <div id="search" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-search"></i>ค้นหาข้อมูลขั้นสูง</h2>
                </div>
                <div class="form-grid" style="margin-bottom: 2rem;">
                    <div class="form-group">
                        <label class="form-label">ประเภทการค้นหา</label>
                        <select id="searchType" class="form-select"></select>
                    </div>
                    <div class="form-group" id="searchTermContainer">
                        <label class="form-label">คำค้นหา</label>
                        <input type="text" id="searchTerm" class="form-input" placeholder="กรอกคำค้นหา (ชื่อหลักสูตร, สาขา, ชื่อคน)...">
                    </div>
                    <div class="form-group hidden" id="searchYearContainer">
                        <label class="form-label">ปี พ.ศ. ที่เกษียณ</label>
                        <select id="searchYear" class="form-select"></select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="performSearch()"><i class="fas fa-search"></i> ค้นหา</button>
                <div id="searchResults" class="mt-5"></div>
            </div>
        </div>

        <footer class="footer">
            <p><i class="fas fa-copyright"></i> Copyright งานถ่ายทอดการพยาบาล ภารกิจด้านการพยาบาล โรงพยาบาลราชวิถี</p>
            <p style="font-size: 0.8rem;">สถานะการเชื่อมต่อ: <span id="connectionStatus">กำลังตรวจสอบ...</span></p>
        </footer>
    </div>

    <div id="detailModal" class="modal" onclick="closeModal('detailModal', event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('detailModal')">&times;</span>
            <div id="detailContent"></div>
        </div>
    </div>
    <div id="editAccessModal" class="modal">
         <div class="modal-content" style="max-width: 450px;">
            <span class="modal-close" onclick="closeModal('editAccessModal')">&times;</span>
            <h3 style="margin-bottom: 1rem; color: var(--primary-dark);">ยืนยันตัวตนเพื่อแก้ไข</h3>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">เพื่อความปลอดภัยของข้อมูล กรุณากรอกเลขที่ใบอนุญาตประกอบวิชาชีพของเจ้าของข้อมูลเพื่อดำเนินการแก้ไข</p>
            <input type="password" id="accessLicenseNumber" class="form-input" placeholder="กรอกเลขที่ใบอนุญาตฯ" style="margin-bottom: 1.5rem;">
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('editAccessModal')">ยกเลิก</button>
                <button class="btn btn-primary" onclick="validateEditAccess()">ยืนยัน</button>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================================
        // CONFIGURATION
        // ===================================================================================
        // !!! สำคัญมาก !!!
        // ให้นำ URL ที่ได้จากการ Deploy ใหม่ มาวางที่นี่
        const API_URL = 'https://script.google.com/macros/s/AKfycbwgiUYsYKrjXgU8Vj3UjczIvLhq60NS5iL12GLX4u_609PL3mZSdHSBRO2rxjsabWdcTA/exec';
        // !!! สำคัญมาก !!!

        const ITEMS_PER_PAGE = 10;
        let state = { databaseNames: [], allRecords: [], filteredRecords: [], currentPage: 1, editingRecordId: null, charts: {} };
        
        document.addEventListener('DOMContentLoaded', initialize);

        async function initialize() {
            setupEventListeners();
            populateStaticDropdowns();
            renderEducationSections();
            showLoading(true);
            await checkConnectionStatus();
            await loadDatabaseNames();
            await loadViewData();
            await setupDashboard();
            showLoading(false);
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', (e) => showTab(e.currentTarget.dataset.tab)));
            document.getElementById('educationForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('birthDate').addEventListener('change', updateRetirementInfo);
            
            ['prefix', 'position', 'level'].forEach(id => {
                 document.getElementById(id).addEventListener('change', handleOtherOption);
                 document.getElementById(id).addEventListener('change', handleConditionalDropdowns);
            });
            
            document.getElementById('firstName').addEventListener('input', e => handleNameInput(e.target, 'firstName'));
            document.getElementById('lastName').addEventListener('input', e => handleNameInput(e.target, 'lastName'));
            document.getElementById('viewSearchInput').addEventListener('input', filterAndDisplayData);
            document.getElementById('sortSelect').addEventListener('change', filterAndDisplayData);
            document.getElementById('dashboardYearSelect').addEventListener('change', updateDashboard);
            document.getElementById('searchType').addEventListener('change', toggleSearchFields);
        }

        async function callAPI(action, payload = {}, method = 'POST') {
            showLoading(true);
            try {
                // สำหรับ POST request เราจะส่งข้อมูลใน body
                const response = await fetch(API_URL, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...payload }),
                    mode: 'cors'
                });

                if (!response.ok) {
                   throw new Error(`Network response was not ok. Status: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                if (result && result.success === false) { // Check for success:false explicitly
                    throw new Error(result.error || 'An unknown API error occurred.');
                }
                return result;
            } catch (error) {
                console.error('API Error:', error);
                showMessage('API Error', error.message, 'error');
                // อัปเดตสถานะการเชื่อมต่อเมื่อเกิด Error
                const statusEl = document.getElementById('connectionStatus');
                statusEl.textContent = `การเชื่อมต่อล้มเหลว (CORS Error)`;
                statusEl.style.color = 'var(--error-color)';
                return null;
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) { document.getElementById('loadingOverlay').classList.toggle('hidden', !show); }
        function showMessage(title, text, icon) { Swal.fire({ title, text, icon, confirmButtonColor: 'var(--primary-color)' }); }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.nav-tab[data-tab='${tabName}']`).classList.add('active');
            
            if(tabName === 'view' && state.allRecords.length === 0) loadViewData();
            if(tabName === 'dashboard') setupDashboard();
        }

        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId, event) {
            if (event && event.target.id !== modalId) return;
            document.getElementById(modalId).style.display = 'none';
        }
        
        async function checkConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = 'กำลังตรวจสอบ...';
            statusEl.style.color = 'var(--text-secondary)';
            const result = await callAPI('test', {}, 'POST'); // Use POST for testing
            if (result && result.success) {
                statusEl.textContent = 'เชื่อมต่อสำเร็จ';
                statusEl.style.color = 'var(--success-color)';
            }
        }
        
        async function loadDatabaseNames() {
            const result = await callAPI('getDatabaseNames', {}, 'POST');
            if (result && result.data) {
                state.databaseNames = result.data;
            }
        }
        
        function populateStaticDropdowns() {
            const createOption = (value, text) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text || value;
                return option;
            };

            const populate = (id, options) => {
                const select = document.getElementById(id);
                select.innerHTML = '';
                select.appendChild(createOption('', `เลือก${options.label}...`));
                options.list.forEach(opt => select.appendChild(createOption(opt)));
                select.appendChild(createOption('อื่นๆ', 'อื่นๆ (กรอกเพิ่มเติม)'));
            };
            
            populate('prefix', { label: 'คำนำหน้า', list: ['นาย', 'นาง', 'นางสาว', 'ดร.', 'ผศ.ดร.', 'รศ.ดร.', 'ศ.ดร.'] });
            populate('position', { label: 'ตำแหน่ง', list: ['พยาบาลวิชาชีพ', 'พยาบาลเทคนิค', 'นักวิชาการสาธารณสุข'] });
            populate('level', { label: 'ระดับ', list: ['ไม่มี', 'ปฏิบัติการ', 'ชำนาญการ', 'ชำนาญการพิเศษ', 'เชี่ยวชาญ'] });

            const currentBuddhistYear = new Date().getFullYear() + 543;
            const yearSelects = ['dashboardYearSelect', 'searchYear'];
            yearSelects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                select.innerHTML = '';
                for (let i = 0; i < 22; i++) {
                    const year = currentBuddhistYear + i - 2;
                    select.appendChild(createOption(year, year));
                }
                select.value = currentBuddhistYear;
            });
            
            const searchTypeSelect = document.getElementById('searchType');
            const searchTypes = {
                'all': 'ค้นหาทั้งหมด', 'retirement': 'ผู้เกษียณอายุ', 'specialized': 'หลักสูตรเฉพาะทาง',
                'preceptor': 'Preceptor', 'masters': 'ปริญญาโท', 'doctoral': 'ปริญญาเอก'
            };
            Object.entries(searchTypes).forEach(([value, text]) => searchTypeSelect.appendChild(createOption(value, text)));
        }

        function handleOtherOption(event) {
            const select = event.target;
            const otherInput = document.getElementById(`${select.id}Other`);
            const isOther = select.value === 'อื่นๆ';
            otherInput.classList.toggle('hidden', !isOther);
            otherInput.required = isOther;
        }
        
        function handleConditionalDropdowns() {
            const isAnyOther = ['prefix', 'position', 'level'].some(id => document.getElementById(id).value === 'อื่นๆ');
            ['department', 'work', 'workGroup'].forEach(id => {
                const textInput = document.getElementById(id);
                const selectInput = document.getElementById(`${id}Select`);
                textInput.classList.toggle('hidden', isAnyOther);
                selectInput.classList.toggle('hidden', !isAnyOther);
                if (isAnyOther) {
                    const uniqueValues = [...new Set(state.databaseNames.map(item => item[id.replace('Select','')] || '').filter(Boolean))];
                    selectInput.innerHTML = `<option value="">เลือก${textInput.previousElementSibling.textContent}...</option>`;
                    uniqueValues.forEach(val => selectInput.innerHTML += `<option value="${val}">${val}</option>`);
                    textInput.value = '';
                } else {
                    selectInput.value = '';
                }
            });
        }

        function handleNameInput(input, field) {
            const suggestionsContainer = document.getElementById(`${field}Suggestions`);
            const term = input.value.toLowerCase();
            suggestionsContainer.innerHTML = '';

            if (term.length < 2) {
                suggestionsContainer.classList.add('hidden');
                return;
            }

            const suggestions = state.databaseNames.filter(item => (item[field] || '').toLowerCase().includes(term));
            if (suggestions.length > 0) {
                suggestions.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'name-suggestion-item';
                    div.textContent = `${item.firstName} ${item.lastName}`;
                    div.onclick = () => selectName(item);
                    suggestionsContainer.appendChild(div);
                });
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        }
        
        function selectName(person) {
            document.getElementById('prefix').value = person.prefix || '';
            document.getElementById('firstName').value = person.firstName || '';
            document.getElementById('lastName').value = person.lastName || '';
            document.getElementById('department').value = person.department || '';
            document.getElementById('work').value = person.work || '';
            document.getElementById('workGroup').value = person.workGroup || '';
            document.querySelectorAll('.name-suggestions').forEach(s => s.classList.add('hidden'));
        }

        function updateRetirementInfo() {
            const birthDate = document.getElementById('birthDate').value;
            if (!birthDate) return;
            const retirementDate = calculateRetirementDate(birthDate);
            document.getElementById('retirementDisplay').textContent = retirementDate;
            document.getElementById('remainingTimeDisplay').textContent = calculateRemainingTime(retirementDate);
        }
        
        function calculateRetirementDate(birthDateStr) {
            if (!birthDateStr) return '';
            const birth = new Date(birthDateStr);
            let retirementYear = birth.getFullYear() + 60;
            if (birth.getMonth() > 8 || (birth.getMonth() === 8 && birth.getDate() > 30)) {
                retirementYear += 1;
            }
            return `30 กันยายน ${retirementYear + 543}`;
        }
        
        function calculateRemainingTime(retirementDateStr) {
            if (!retirementDateStr || !retirementDateStr.includes(' ')) return 'N/A';
            const parts = retirementDateStr.split(' ');
            const retirementDate = new Date(parseInt(parts[2]) - 543, 8, 30);
            const today = new Date();
            if (retirementDate <= today) return 'เกษียณแล้ว';
            
            let years = retirementDate.getFullYear() - today.getFullYear();
            let months = retirementDate.getMonth() - today.getMonth();
            let days = retirementDate.getDate() - today.getDate();

            if (days < 0) {
                months--;
                days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }
            return `${years} ปี ${months} เดือน ${days} วัน`;
        }

        function renderEducationSections() {
            const container = document.getElementById('education-sections-container');
            container.innerHTML = '';
            const sections = [
                {
                    id: 'specializedCourse', title: 'หลักสูตรการพยาบาลเฉพาะทาง', icon: 'fa-graduation-cap',
                    fields: [ { name: 'courseName', label: 'ชื่อหลักสูตร' }, { name: 'institution', label: 'สถาบัน' }, { name: 'graduationYear', label: 'ปีที่จบ' } ]
                },
                {
                    id: 'preceptorCourse', title: 'หลักสูตร Preceptor', icon: 'fa-chalkboard-teacher',
                    fields: [ { name: 'duration', label: 'ระยะเวลาเรียน', placeholder: 'เช่น 40 ชั่วโมง' }, { name: 'graduationYear', label: 'ปีที่จบ' } ]
                },
                {
                    id: 'mastersDegree', title: 'หลักสูตรปริญญาโท', icon: 'fa-user-graduate',
                    fields: [
                        { name: 'major', label: 'สาขา' }, { name: 'institution', label: 'สถาบัน' }, { name: 'graduationYear', label: 'ปีที่จบ' },
                        { name: 'educationType', label: 'ประเภทการศึกษา', type: 'select', options: ['ภาคในเวลาราชการ', 'ภาคนอกเวลาราชการ'], tooltip: 'ภาคในเวลาราชการ: เรียนโดยใช้ทุน... | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัว...' },
                        { name: 'scholarship', label: 'ทุนการศึกษา', type: 'selectOther', options: ['ทุนกรมการแพทย์', 'ทุนรพ.ราชวิถี', 'ทุนส่วนตัว'] }
                    ]
                },
                {
                    id: 'doctoralDegree', title: 'หลักสูตรปริญญาเอก', icon: 'fa-award',
                    fields: [
                        { name: 'major', label: 'สาขา' }, { name: 'institution', label: 'สถาบัน' }, { name: 'graduationYear', label: 'ปีที่จบ' },
                        { name: 'educationType', label: 'ประเภทการศึกษา', type: 'select', options: ['ภาคในเวลาราชการ', 'ภาคนอกเวลาราชการ'], tooltip: 'ภาคในเวลาราชการ: เรียนโดยใช้ทุน... | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัว...' },
                        { name: 'scholarship', label: 'ทุนการศึกษา', type: 'selectOther', options: ['ทุนกรมการแพทย์', 'ทุนรพ.ราชวิถี', 'ทุนส่วนตัว'] }
                    ]
                }
            ];
            sections.forEach(s => {
                const sectionHTML = `<div class="form-section">
                        <div class="form-section-title"><i class="fas ${s.icon}"></i>${s.title} *</div>
                        <div class="radio-group">
                            <label class="radio-item"><input type="radio" name="has${s.id.charAt(0).toUpperCase() + s.id.slice(1)}" value="เรียน" onclick="toggleCourseSection(this, true)"><span>เรียน</span></label>
                            <label class="radio-item"><input type="radio" name="has${s.id.charAt(0).toUpperCase() + s.id.slice(1)}" value="ไม่ได้เรียน" onclick="toggleCourseSection(this, false)"><span>ไม่ได้เรียน</span></label>
                        </div>
                        <div id="${s.id}Section" class="course-section">
                            <div class="course-header">
                                <h3 class="course-title">รายละเอียด${s.title}</h3>
                                <button type="button" class="btn btn-primary btn-icon" onclick="addCourseItem('${s.id}')" title="เพิ่มรายการ"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="${s.id}List"></div>
                        </div>
                    </div>`;
                container.innerHTML += sectionHTML;
                addCourseItem(s.id, {});
            });
        }
        
        function toggleCourseSection(radio, show) {
            const section = radio.closest('.form-section').querySelector('.course-section');
            section.classList.toggle('show', show);
            radio.parentElement.classList.add('checked');
            const sibling = radio.parentElement.nextElementSibling || radio.parentElement.previousElementSibling;
            if(sibling) sibling.classList.remove('checked');
        }

        function addCourseItem(sectionId, data = {}) {
            const list = document.getElementById(`${sectionId}List`);
            const itemIndex = list.children.length;
            const newItem = document.createElement('div');
            newItem.className = 'course-item';

            const sectionConfig = {
                specializedCourse: [{ name: 'courseName', label: 'ชื่อหลักสูตร' }, { name: 'institution', label: 'สถาบัน' }, { name: 'graduationYear', label: 'ปีที่จบ' }],
                preceptorCourse: [{ name: 'duration', label: 'ระยะเวลาเรียน' }, { name: 'graduationYear', label: 'ปีที่จบ' }],
                mastersDegree: [
                    { name: 'major', label: 'สาขา' }, { name: 'institution', label: 'สถาบัน' }, { name: 'graduationYear', label: 'ปีที่จบ' },
                    { name: 'educationType', label: 'ประเภทการศึกษา', type: 'select', options: ['ภาคในเวลาราชการ', 'ภาคนอกเวลาราชการ'], tooltip: 'ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว... | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัว...' },
                    { name: 'scholarship', label: 'ทุนการศึกษา', type: 'selectOther', options: ['ทุนกรมการแพทย์', 'ทุนรพ.ราชวิถี', 'ทุนส่วนตัว'] }
                ],
                doctoralDegree: [
                    { name: 'major', label: 'สาขา' }, { name: 'institution', label: 'สถาบัน' }, { name: 'graduationYear', label: 'ปีที่จบ' },
                    { name: 'educationType', label: 'ประเภทการศึกษา', type: 'select', options: ['ภาคในเวลาราชการ', 'ภาคนอกเวลาราชการ'], tooltip: 'ภาคในเวลาราชการ: เรียนโดยใช้ทุนส่วนตัว... | ภาคนอกเวลาราชการ: ใช้ทุนส่วนตัว...' },
                    { name: 'scholarship', label: 'ทุนการศึกษา', type: 'selectOther', options: ['ทุนกรมการแพทย์', 'ทุนรพ.ราชวิถี', 'ทุนส่วนตัว'] }
                ]
            }[sectionId];

            let fieldsHTML = sectionConfig.map(field => {
                const fieldName = `${sectionId}[${itemIndex}][${field.name}]`;
                const value = data[field.name] || '';
                let inputHTML = '';
                switch (field.type) {
                    case 'select':
                        inputHTML = `<select class="form-select" name="${fieldName}">${field.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>`;
                        if (field.tooltip) inputHTML = `<div class="tooltip-container">${inputHTML}<i class="fas fa-info-circle tooltip-icon"></i><span class="tooltip-text">${field.tooltip}</span></div>`;
                        break;
                    case 'selectOther':
                        const otherValue = !field.options.includes(value) && value ? value : '';
                        const selectValue = otherValue ? 'อื่นๆ' : value;
                        inputHTML = `<select class="form-select" name="${fieldName}" onchange="this.nextElementSibling.classList.toggle('hidden', this.value !== 'อื่นๆ')">
                                <option value="">เลือก...</option>
                                ${field.options.map(opt => `<option value="${opt}" ${selectValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                <option value="อื่นๆ" ${selectValue === 'อื่นๆ' ? 'selected' : ''}>อื่นๆ</option>
                            </select>
                            <input class="form-input mt-2 ${otherValue ? '' : 'hidden'}" name="${fieldName}[other]" placeholder="ระบุอื่นๆ" value="${otherValue}">`;
                        break;
                    default:
                        inputHTML = `<input class="form-input" type="text" name="${fieldName}" placeholder="${field.placeholder || field.label}" value="${value}">`;
                }
                return `<div class="form-group"><label class="form-label">${field.label}</label>${inputHTML}</div>`;
            }).join('');

            newItem.innerHTML = fieldsHTML + `<div class="delete-btn-container"><button type="button" class="btn btn-danger btn-icon" onclick="this.closest('.course-item').remove(); updateDeleteButtons('${sectionId}')"><i class="fas fa-trash"></i></button></div>`;
            list.appendChild(newItem);
            updateDeleteButtons(sectionId);
        }
        
        function updateDeleteButtons(sectionId) {
            const items = document.querySelectorAll(`#${sectionId}List .course-item`);
            items.forEach((item, index) => {
                const btn = item.querySelector('.delete-btn-container');
                if (btn) btn.style.display = items.length > 1 ? 'block' : 'none';
            });
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            let data = { id: state.editingRecordId };
            
            for (let [key, value] of formData.entries()) {
                if (!key.includes('[')) data[key] = value;
            }
            ['prefix', 'position', 'level'].forEach(id => { if (data[id] === 'อื่นๆ') data[id] = formData.get(`${id}Other`); });
            if(['prefix', 'position', 'level'].some(id => document.getElementById(id).value === 'อื่นๆ')) {
                data.department = formData.get('departmentSelect');
                data.work = formData.get('workSelect');
                data.workGroup = formData.get('workGroupSelect');
            }

            ['specializedCourse', 'preceptorCourse', 'mastersDegree', 'doctoralDegree'].forEach(sectionId => {
                const items = [];
                document.querySelectorAll(`#${sectionId}List .course-item`).forEach((item) => {
                    const courseData = {};
                    item.querySelectorAll('input, select').forEach(input => {
                        const nameMatch = input.name.match(/\[(\w+)\]/);
                        if (nameMatch) {
                            let key = nameMatch[1];
                            let value = input.value;
                            if (key === 'scholarship' && value === 'อื่นๆ') {
                                value = item.querySelector(`input[name*="[scholarship][other]"]`).value;
                            }
                            if (value) courseData[key] = value;
                        }
                    });
                    if (Object.keys(courseData).length > 0) items.push(courseData);
                });
                const radioName = `has${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`;
                data[radioName] = form.elements[radioName] ? form.elements[radioName].value : 'ไม่ได้เรียน';
                data[`${sectionId}s`] = items;
            });
            
            const action = state.editingRecordId ? 'update' : 'create';
            const result = await callAPI(action, data);
            
            if (result) {
                showMessage(action === 'update' ? 'อัปเดตสำเร็จ' : 'บันทึกสำเร็จ', 'ข้อมูลของคุณถูกบันทึกเรียบร้อยแล้ว', 'success');
                resetForm();
                await loadViewData();
            }
        }
        
        function resetForm() {
            document.getElementById('educationForm').reset();
            state.editingRecordId = null;
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-plus"></i>แบบฟอร์มกรอกข้อมูล';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> บันทึกข้อมูล';
            document.querySelectorAll('.course-section').forEach(s => s.classList.remove('show'));
            document.querySelectorAll('.radio-item').forEach(r => r.classList.remove('checked'));
            document.querySelectorAll('input[name*="Other"]').forEach(i => i.classList.add('hidden'));
            document.querySelectorAll('.name-suggestions').forEach(s => s.classList.add('hidden'));
            renderEducationSections();
        }

        async function loadViewData() {
            const result = await callAPI('read', {}, 'POST');
            if (result && result.data) {
                state.allRecords = result.data;
                filterAndDisplayData();
            }
        }
        
        function filterAndDisplayData() {
            const searchTerm = document.getElementById('viewSearchInput').value.toLowerCase();
            const sortOrder = document.getElementById('sortSelect').value;
            let records = [...state.allRecords];
            if (searchTerm) {
                records = records.filter(rec => JSON.stringify(rec).toLowerCase().includes(searchTerm));
            }
            records.sort((a, b) => {
                switch(sortOrder) {
                    case 'name_asc': return `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`, 'th');
                    case 'name_desc': return `${b.firstName} ${b.lastName}`.localeCompare(`${a.firstName} ${a.lastName}`, 'th');
                    case 'oldest': return new Date(a.timestamp.split(' ')[0].split('/').reverse().join('-')) - new Date(b.timestamp.split(' ')[0].split('/').reverse().join('-'));
                    case 'newest':
                    default: return new Date(b.timestamp.split(' ')[0].split('/').reverse().join('-')) - new Date(a.timestamp.split(' ')[0].split('/').reverse().join('-'));
                }
            });
            state.filteredRecords = records;
            state.currentPage = 1;
            renderTablePage();
        }

        function renderTablePage() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            const startIndex = (state.currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const pageData = state.filteredRecords.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 2rem;">ไม่พบข้อมูล</td></tr>`;
            } else {
                pageData.forEach((rec, index) => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${startIndex + index + 1}</td>
                            <td>${rec.prefix || ''} ${rec.firstName || ''} ${rec.lastName || ''}</td>
                            <td>${rec.position || 'N/A'}</td>
                            <td>${rec.department || 'N/A'}</td>
                            <td class="table-actions" style="text-align:center;">
                                <button class="btn btn-primary" onclick="showDetail('${rec.id}')"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-warning" onclick="requestEdit('${rec.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger" onclick="deleteRecord('${rec.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                });
            }
            updatePaginationControls();
        }
        
        function updatePaginationControls() {
            const totalPages = Math.ceil(state.filteredRecords.length / ITEMS_PER_PAGE) || 1;
            document.getElementById('dataCount').textContent = `แสดง ${state.filteredRecords.length} จาก ${state.allRecords.length} รายการ`;
            document.getElementById('pageInfo').textContent = `หน้า ${state.currentPage} / ${totalPages}`;
            document.getElementById('prevBtn').disabled = state.currentPage === 1;
            document.getElementById('nextBtn').disabled = state.currentPage === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(state.filteredRecords.length / ITEMS_PER_PAGE);
            const newPage = state.currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                state.currentPage = newPage;
                renderTablePage();
            }
        }

        function showDetail(id) {
            const rec = state.allRecords.find(r => r.id === id);
            if (!rec) return;
            const renderCourseList = (courses, fields) => {
                if (!courses || courses.length === 0) return '<p>ไม่มีข้อมูล</p>';
                return courses.map(course => `<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                        ${fields.map(field => `<div><strong>${field.label}:</strong> ${course[field.key] || 'N/A'}</div>`).join('')}
                    </div>`).join('');
            };
            document.getElementById('detailContent').innerHTML = `<h2 style="color: var(--primary-dark); margin-bottom: 2rem;">รายละเอียด: ${rec.prefix} ${rec.firstName} ${rec.lastName}</h2>
                <div class="detail-grid">
                    <div class="detail-section"><h4>ข้อมูลส่วนบุคคล</h4>
                        <p><strong>ตำแหน่ง:</strong> ${rec.position || 'N/A'} (${rec.level || 'N/A'})</p>
                        <p><strong>หน่วยงาน:</strong> ${rec.department || 'N/A'}</p><p><strong>งาน:</strong> ${rec.work || 'N/A'}</p><p><strong>กลุ่มงาน:</strong> ${rec.workGroup || 'N/A'}</p>
                        <p><strong>วันเกิด:</strong> ${rec.birthDate || 'N/A'}</p><p><strong>วันเกษียณ:</strong> ${rec.retirementDate || 'N/A'}</p><p><strong>เวลาที่เหลือ:</strong> ${rec.remainingTime || 'N/A'}</p>
                        <p><strong>วันที่บันทึก:</strong> ${rec.timestamp || 'N/A'}</p>
                    </div>
                    <div class="detail-section"><h4>การพยาบาลเฉพาะทาง: ${rec.hasSpecializedCourse}</h4>
                        ${renderCourseList(rec.specializedCourses, [{key: 'courseName', label: 'หลักสูตร'}, {key: 'institution', label: 'สถาบัน'}, {key: 'graduationYear', label: 'ปีจบ'}])}
                    </div>
                    <div class="detail-section"><h4>Preceptor: ${rec.hasPreceptorCourse}</h4>
                        ${renderCourseList(rec.preceptorCourses, [{key: 'duration', label: 'ระยะเวลา'}, {key: 'graduationYear', label: 'ปีจบ'}])}
                    </div>
                    <div class="detail-section"><h4>ปริญญาโท: ${rec.hasMastersDegree}</h4>
                        ${renderCourseList(rec.mastersDegrees, [{key: 'major', label: 'สาขา'}, {key: 'institution', label: 'สถาบัน'}, {key: 'graduationYear', label: 'ปีจบ'}, {key: 'educationType', label: 'ประเภท'}, {key: 'scholarship', label: 'ทุน'}])}
                    </div>
                    <div class="detail-section"><h4>ปริญญาเอก: ${rec.hasDoctoralDegree}</h4>
                        ${renderCourseList(rec.doctoralDegrees, [{key: 'major', label: 'สาขา'}, {key: 'institution', label: 'สถาบัน'}, {key: 'graduationYear', label: 'ปีจบ'}, {key: 'educationType', label: 'ประเภท'}, {key: 'scholarship', label: 'ทุน'}])}
                    </div>
                </div>`;
            openModal('detailModal');
        }

        function requestEdit(id) {
            state.editingRecordId = id;
            document.getElementById('accessLicenseNumber').value = '';
            openModal('editAccessModal');
        }

        async function validateEditAccess() {
            const licenseNumber = document.getElementById('accessLicenseNumber').value;
            if (!licenseNumber) return showMessage('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกเลขที่ใบอนุญาต', 'warning');
            const result = await callAPI('validateEdit', { recordId: state.editingRecordId, licenseNumber });
            if (result && result.data) {
                closeModal('editAccessModal');
                populateFormForEdit(result.data);
            }
        }
        
        function populateFormForEdit(rec) {
            resetForm();
            state.editingRecordId = rec.id;
            Object.keys(rec).forEach(key => {
                const el = document.getElementById(key);
                if (el) el.value = rec[key];
            });
            ['prefix', 'position', 'level'].forEach(id => {
                const select = document.getElementById(id);
                if (![...select.options].some(opt => opt.value === rec[id])) {
                    select.value = 'อื่นๆ';
                    const otherInput = document.getElementById(`${id}Other`);
                    otherInput.value = rec[id];
                    otherInput.classList.remove('hidden');
                }
            });
            ['SpecializedCourse', 'PreceptorCourse', 'MastersDegree', 'DoctoralDegree'].forEach(course => {
                const radioName = `has${course}`;
                if (rec[radioName]) {
                    const radio = document.querySelector(`input[name="${radioName}"][value="${rec[radioName]}"]`);
                    if (radio) { radio.checked = true; toggleCourseSection(radio, rec[radioName] === 'เรียน'); }
                }
                const courseData = rec[`${course.toLowerCase()}s`];
                const listId = `${course.charAt(0).toLowerCase() + course.slice(1)}List`;
                document.getElementById(listId).innerHTML = '';
                if (courseData && courseData.length > 0) {
                    courseData.forEach(item => addCourseItem(listId.replace('List',''), item));
                } else { addCourseItem(listId.replace('List','')); }
            });

            updateRetirementInfo();
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit"></i>แก้ไขข้อมูล';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i>อัปเดตข้อมูล';
            showTab('form');
            window.scrollTo(0, 0);
        }

        function deleteRecord(id) {
            Swal.fire({
                title: 'ยืนยันการลบ', text: "คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลนี้?", icon: 'warning',
                showCancelButton: true, confirmButtonColor: 'var(--error-color)', cancelButtonColor: '#aaa',
                confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const deleteResult = await callAPI('delete', { id });
                    if (deleteResult) {
                        showMessage('ลบสำเร็จ', 'ข้อมูลถูกลบออกจากระบบแล้ว', 'success');
                        await loadViewData();
                    }
                }
            });
        }
        
        async function exportData(format) {
            showMessage('กำลังเตรียมไฟล์', `กำลังสร้างไฟล์ ${format.toUpperCase()}...`, 'info');
            const result = await callAPI('exportData', { format }, 'POST');
            if (result && result.downloadUrl) {
                window.open(result.downloadUrl, '_blank');
            }
        }
        
        async function setupDashboard() {
            const year = document.getElementById('dashboardYearSelect').value;
            const result = await callAPI('getDashboardData', { retirementYear: year }, 'POST');
            if (result && result.data) renderDashboard(result.data, year);
        }
        
        async function updateDashboard() { await setupDashboard(); }

        function renderDashboard(data, year) {
            const stats = [
                { icon: 'fa-users', value: data.totalNurses, label: 'พยาบาลทั้งหมด', color: 'linear-gradient(135deg, #667eea, #764ba2)'},
                { icon: 'fa-user-clock', value: data.retirementCount, label: `ผู้เกษียณปี ${year}`, color: 'linear-gradient(135deg, #f093fb, #f5576c)'},
                { icon: 'fa-graduation-cap', value: data.educationStats.specialized, label: 'เฉพาะทาง', color: 'linear-gradient(135deg, #4facfe, #00f2fe)'},
                { icon: 'fa-chalkboard-teacher', value: data.educationStats.preceptor, label: 'Preceptor', color: 'linear-gradient(135deg, #43e97b, #38f9d7)'}
            ];
            document.getElementById('statCardsContainer').innerHTML = stats.map(s => `<div class="stat-card" style="background:${s.color};"><i class="fas ${s.icon}"></i><h3>${s.value}</h3><p>${s.label}</p></div>`).join('');
            document.getElementById('retirementListTitle').textContent = `รายชื่อผู้เกษียณอายุปี พ.ศ. ${year}`;
            document.getElementById('retirementList').innerHTML = data.retirementList.length > 0 ? 
                `<table class="data-table" style="box-shadow:none;"><thead><tr><th>ชื่อ</th><th>ตำแหน่ง</th><th>หน่วยงาน</th></tr></thead><tbody>${data.retirementList.map(p => `<tr><td>${p.fullName}</td><td>${p.position}</td><td>${p.department}</td></tr>`).join('')}</tbody></table>` : 
                '<p style="text-align:center; padding: 2rem;">ไม่มีข้อมูลผู้เกษียณในปีนี้</p>';
            
            renderChart('educationPieChart', 'pie', {
                labels: ['เฉพาะทาง', 'Preceptor', 'ป.โท', 'ป.เอก'],
                datasets: [{ data: [data.educationStats.specialized, data.educationStats.preceptor, data.educationStats.masters, data.educationStats.doctoral], backgroundColor: ['#e91e63', '#3f51b5', '#ff9800', '#4caf50'] }]
            });
            renderChart('educationTypeBarChart', 'bar', {
                labels: ['ป.โท', 'ป.เอก'],
                datasets: [
                    { label: 'ในเวลา', data: [data.educationStats.mastersInOfficeTime, data.educationStats.doctoralInOfficeTime], backgroundColor: '#3f51b5' },
                    { label: 'นอกเวลา', data: [data.educationStats.mastersOutOfficeTime, data.educationStats.doctoralOutOfficeTime], backgroundColor: '#4caf50' }
                ]
            }, { scales: { x: { stacked: true }, y: { stacked: true } } });
            
            const retirementYears = Object.keys(data.retirementStats || {}).sort();
            renderChart('retirementBarChart', 'bar', {
                labels: retirementYears,
                datasets: [{ label: 'จำนวนผู้เกษียณ', data: retirementYears.map(y => data.retirementStats[y]), backgroundColor: '#f5576c' }]
            });
        }
        
        function renderChart(canvasId, type, data, options = {}) {
            if (state.charts[canvasId]) state.charts[canvasId].destroy();
            const ctx = document.getElementById(canvasId).getContext('2d');
            state.charts[canvasId] = new Chart(ctx, { type, data, options });
        }
        
        function toggleSearchFields() {
            const type = document.getElementById('searchType').value;
            document.getElementById('searchYearContainer').classList.toggle('hidden', type !== 'retirement');
            document.getElementById('searchTermContainer').classList.toggle('hidden', type === 'preceptor' || type === 'retirement');
        }

        async function performSearch() {
            const type = document.getElementById('searchType').value;
            const term = document.getElementById('searchTerm').value;
            const year = document.getElementById('searchYear').value;
            
            const result = await callAPI('search', { type, term, year }, 'POST');
            const container = document.getElementById('searchResults');
            if (result && result.data.length > 0) {
                container.innerHTML = `<p style="margin-bottom: 1rem;">พบ ${result.data.length} รายการ</p>
                <table class="data-table"><thead><tr><th>ชื่อ-นามสกุล</th><th>ตำแหน่ง</th><th>หน่วยงาน</th><th>รายละเอียด</th></tr></thead><tbody>
                ${result.data.map(rec => `<tr><td>${rec.prefix} ${rec.firstName} ${rec.lastName}</td><td>${rec.position}</td><td>${rec.department}</td><td style="text-align:center;"><button class="btn btn-primary" onclick="showDetail('${rec.id}')"><i class="fas fa-eye"></i></button></td></tr>`).join('')}
                </tbody></table>`;
            } else {
                container.innerHTML = '<p style="text-align:center; padding: 2rem;">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</p>';
            }
        }
    </script>
</body>
</html>
